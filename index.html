<!-- --- Paste ini tepat sebelum akhir file index.html, di dalam <script> utama --- -->
<script>
let chartSales = null; // fix ReferenceError: chartSales before initialization
</script>

(function(){
  // helper select
  const $ = id => document.getElementById(id);

  // 1) Pastikan ada tombol Buka Kasir di topbar — buat kalau belum ada
  if(!$('btnOpenPOSTop')){
    const top = document.querySelector('.top-actions');
    if(top){
      const btn = document.createElement('button');
      btn.id = 'btnOpenPOSTop';
      btn.className = 'small';
      btn.style.background = '#0f6b63';
      btn.style.color = '#fff';
      btn.textContent = 'Buka Kasir';
      // insert as first child so terlihat
      top.insertBefore(btn, top.firstChild);
    }
  }

  // 2) Jika nav Pengaturan tidak bereaksi, pastikan showPage terdaftar dan nav button clickable
  function safeShowPage(name){
    // fall back simple show/hide in case original function missing
    try{
      // try call original showPage if exists
      if(window.showPage) { window.showPage(name); return; }
      // otherwise use existing page ids
      const pages = ['page_dashboard','page_sales','page_products','page_reports','page_settings'];
      pages.forEach(pid=>{ const el = document.getElementById(pid); if(el) el.style.display='none'; });
      const map = {dashboard:'page_dashboard', sales:'page_sales', products:'page_products', reports:'page_reports', settings:'page_settings'};
      const target = map[name];
      if(target) document.getElementById(target).style.display='block';
    }catch(err){
      console.error('safeShowPage err', err);
    }
  }

  // attach to topbar button
  const topBtn = $('btnOpenPOSTop');
  if(topBtn) topBtn.addEventListener('click', ()=>{ 
    // if overlay available, use it
    const ov = document.getElementById('overlay');
    if(ov){ ov.style.display = 'flex'; return; }
    alert('Kasir (POS) tidak tersedia — pastikan file POS ada (overlay id="overlay")');
  });

  // attach the sidebar Pengaturan nav (safe)
  const navSettings = document.getElementById('nav_settings');
  if(navSettings) navSettings.addEventListener('click', ()=> safeShowPage('settings'));

  const navSales = document.getElementById('nav_sales');
  if(navSales) navSales.addEventListener('click', ()=> safeShowPage('sales'));

  // 3) Tambah filter singkat di buku kas: Harian / Mingguan (dom inject)
  (function insertLedgerFilter(){
    const ledgerCard = document.querySelector('.right-panel.card'); // where ledger usually is
    if(!ledgerCard) return;
    // avoid duplicate
    if(document.getElementById('ledgerQuickFilter')) return;
    const div = document.createElement('div');
    div.id = 'ledgerQuickFilter';
    div.style.margin = '8px 0';
    div.innerHTML = `
    .sidebar button {
  font-size: 15px;
  font-weight: 500;
  color: #eaf5f4;
}

.sidebar button.active {
  background: rgba(255, 255, 255, 0.15);
  color: #ffffff;
}

.sidebar button:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
}
.sidebar button small {
  color: #b6dfda;
  font-size: 12px;
}

      <label style="display:block;margin-bottom:6px" class="muted">Tampilkan:</label>
      <select id="ledgerRange" style="padding:6px;border-radius:8px;border:1px solid #e6e9ef">
        <option value="daily">Harian</option>
        <option value="weekly">Mingguan</option>
        <option value="all">Semua</option>
      </select>
    `;
    ledgerCard.insertBefore(div, ledgerCard.firstChild);

    // function to filter table
    function applyLedgerFilter(){
      const mode = document.getElementById('ledgerRange').value;
      // assume original renderTableSales() exists and uses global 'data'. If not, do custom
      try{
        if(typeof window.renderTableSales === 'function'){
          // if original supports filter param, try calling with boolean (if implemented)
          // otherwise we re-render table by ourselves
          if(window.renderTableSales.length){ window.renderTableSales(mode); return; } // if expects a param
        }
      }catch(e){ console.warn(e) }

      // fallback manual filter + render into #tableSales tbody
      const tbody = document.querySelector('#tableSales tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      const now = new Date();
      const rows = data.slice().reverse().filter(tx=>{
        if(mode==='all') return true;
        const d = new Date(tx.t);
        if(mode==='daily') return d.getFullYear()==now.getFullYear() && d.getMonth()==now.getMonth() && d.getDate()==now.getDate();
        if(mode==='weekly'){
          // week: last 7 days including today
          const diff = (now - d) / (1000*60*60*24);
          return diff <= 7;
        }
        return true;
      });
      rows.forEach((tx,i)=>{
        const tr = document.createElement('tr');
        const date = new Date(tx.t).toLocaleString();
        const desc = tx.type=='sale' ? `${tx.item} (x${tx.qty||1})` : (tx.desc || 'Pengeluaran');
        const debit = tx.type=='sale' ? (window.fmt? window.fmt(tx.total) : ('Rp '+(tx.total||0))) : '';
        const credit = tx.type=='expense' ? (window.fmt? window.fmt(tx.amount) : ('Rp '+(tx.amount||0))) : '';
        const method = tx.method || '';
        tr.innerHTML = `<td>${date}</td><td>${desc}</td><td>${method}</td><td>${debit}</td><td>${credit}</td><td></td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('ledgerRange').addEventListener('change', applyLedgerFilter);
    // run once
    applyLedgerFilter();
  })();

  // 4) Quick diagnostics: print console errors if pengaturan button present but page not visible
  setTimeout(()=>{
    try{
      const s = document.getElementById('page_settings');
      if(s && getComputedStyle(s).display === 'none'){
        console.log('Pengaturan ada tapi tersembunyi — klik nav Pengaturan untuk membukanya.');
      }
    }catch(e){}
  },500);

  console.log('Patch UI helper injected — POS top button + ledger quick filter ready.');
})();
</script>
