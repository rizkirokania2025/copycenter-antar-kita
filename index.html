<script>
/* ======= Clean PRO script (replace previous script block) ======= */
/* Storage keys */
(function(){
  const PRODUCTS = 'cc_products_v1';
  const TX = 'cc_tx_v1';
  const SETTINGS = 'cc_settings_v1';
  // helpers
  const $ = id => document.getElementById(id);
  function money(n){ return 'Rp ' + Number(n||0).toLocaleString('id-ID'); }
  function nowISO(){ return new Date().toISOString(); }
  function getStore(k, def){ try{ return JSON.parse(localStorage.getItem(k)) || def }catch(e){ return def } }
  function setStore(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

  // init default data if missing
  if(!localStorage.getItem(PRODUCTS)){
    const sample = [
      {id:'p1',name:'Fotokopi B/W',cat:'Fotokopi',price:1500,stock:200},
      {id:'p2',name:'Fotokopi Warna',cat:'Fotokopi',price:4000,stock:50},
      {id:'p3',name:'Print Pas Foto',cat:'Fotokopi',price:20000,stock:20},
      {id:'p4',name:'Pulpen',cat:'ATK',price:3000,stock:100},
      {id:'p5',name:'Aqua 600ml',cat:'Minuman',price:5000,stock:60}
    ];
    setStore(PRODUCTS, sample);
  }
  if(!localStorage.getItem(TX)) setStore(TX, []);
  if(!localStorage.getItem(SETTINGS)) setStore(SETTINGS, {pin:'1234',pin_enabled:true,theme:'light'});

  // UI refs
  const productSelect = $('productSelect');
  const posProduct = $('posProduct');
  const productTableBody = document.querySelector('#productTable tbody');
  const ledgerBody = document.querySelector('#ledgerTable tbody');
  const btnAddTx = $('btnAddTx');
  const btnQuick = $('btnQuick');
  const btnStockIn = $('btnStockIn');
  const btnExportCSV = $('btnExportCSV');
  const btnExportStock = $('btnExportStock');
  const btnImportCSV = $('btnImportCSV');
  const fileInput = $('fileInput');
  const btnBackup = $('btnBackup');
  const btnPrintPDF = $('btnPrintPDF');
  const openPOS = $('openPOS');
  const posModal = $('posModal');
  const posQty = $('posQty');
  const posAdd = $('posAdd');
  const posCart = document.querySelector('#posCart tbody');
  const posTotal = $('posTotal');
  const posCheckout = $('posCheckout');
  const posPrint = $('posPrint');
  const posClose = $('posClose');
  const sumIncomeEl = $('sumIncome');
  const sumExpenseEl = $('sumExpense');
  const sumProfitEl = $('sumProfit');
  const txType = $('txType');
  const saleFields = $('saleFields');
  const expenseFields = $('expenseFields');
  const productTable = document.querySelector('#productTable');

  // load state
  let products = getStore(PRODUCTS, []);
  let tx = getStore(TX, []);
  let settings = getStore(SETTINGS, {});

  // render helpers
  function renderProducts(){
    products = getStore(PRODUCTS, []);
    // categories for filter
    const cats = ['all', ...new Set(products.map(p=>p.cat))];
    const filterCategory = $('filterCategory');
    filterCategory.innerHTML = cats.map(c => `<option value="${c}">${c==='all'?'Semua':c}</option>`).join('');
    productSelect.innerHTML = products.map(p => `<option value="${p.id}">${p.name} — Rp ${p.price.toLocaleString('id-ID')}</option>`).join('');
    posProduct.innerHTML = productSelect.innerHTML;
    // table body
    productTableBody.innerHTML = products.map(p => `
      <tr data-id="${p.id}">
        <td>${p.name}</td>
        <td>${p.cat}</td>
        <td>${money(p.price)}</td>
        <td>${p.stock}</td>
        <td><button class="small ghost edit-product" data-id="${p.id}">Edit</button></td>
      </tr>
    `).join('');
  }

  function renderLedger(filter='all'){
    tx = getStore(TX, []);
    const rows = tx.slice().reverse().filter(t=>{
      if(filter==='daily'){
        const d = new Date(t.t), n = new Date();
        return d.getFullYear()==n.getFullYear() && d.getMonth()==n.getMonth() && d.getDate()==n.getDate();
      }
      if(filter==='weekly'){
        const d = new Date(t.t), now = new Date(); const diff = (now - d)/(1000*60*60*24);
        return diff <= 7;
      }
      return true;
    });
    ledgerBody.innerHTML = rows.map(r => `
      <tr>
        <td>${new Date(r.t).toLocaleString()}</td>
        <td>${r.type==='sale'? r.item : r.desc}</td>
        <td>${r.cat||''}</td>
        <td>${r.type==='sale'? money(r.total) : ''}</td>
        <td>${r.type==='expense'? money(r.amount) : ''}</td>
        <td><button class="small ghost remove-tx" data-id="${tx.indexOf(r)}">Hapus</button></td>
      </tr>
    `).join('');
  }

  function renderSummary(){
    tx = getStore(TX, []);
    const income = tx.filter(t=>t.type==='sale').reduce((s,n)=> s + Number(n.total||0), 0);
    const expense = tx.filter(t=>t.type==='expense').reduce((s,n)=> s + Number(n.amount||0), 0);
    sumIncomeEl.textContent = money(income);
    sumExpenseEl.textContent = money(expense);
    sumProfitEl.textContent = money(income - expense);
  }

  // actions
  function addSale(item, qty, price, options={}){
    const total = qty * price;
    const obj = {type:'sale', item, qty, price, total, t: nowISO(), ...options};
    tx.push(obj); setStore(TX, tx);
    if(options.productId){
      const p = products.find(x=>x.id===options.productId);
      if(p) { p.stock = Math.max(0, p.stock - qty); setStore(PRODUCTS, products); }
    }
    renderProducts(); renderLedger('all'); renderSummary();
  }
  function addExpense(desc, cat, amount){
    const obj = {type:'expense', desc, cat, amount, t: nowISO()};
    tx.push(obj); setStore(TX, tx); renderLedger('all'); renderSummary();
  }

  // event wiring (safe, no inline onclick)
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('edit-product')){
      const id = e.target.dataset.id;
      const p = products.find(x=>x.id===id);
      if(!p) return alert('Produk tidak ditemukan');
      const newName = prompt('Nama produk', p.name);
      if(newName===null) return;
      const newCat = prompt('Kategori', p.cat) || p.cat;
      const newPrice = Number(prompt('Harga', p.price) || p.price);
      const newStock = Number(prompt('Stok', p.stock) || p.stock);
      p.name = newName; p.cat = newCat; p.price = newPrice; p.stock = newStock;
      setStore(PRODUCTS, products); renderProducts(); renderLedger('all');
    }
    if(e.target && e.target.classList.contains('remove-tx')){
      const idx = Number(e.target.dataset.id);
      if(!confirm('Hapus transaksi?')) return;
      tx.splice(idx,1); setStore(TX, tx); renderLedger('all'); renderSummary();
    }
  });

  // button handlers
  btnAddTx.addEventListener('click', ()=>{
    if(txType.value === 'sale'){
      const pid = productSelect.value;
      const p = products.find(x=>x.id===pid);
      const itemName = $('itemName').value.trim() || (p? p.name : 'Penjualan');
      const qty = Number($('qty').value) || 1;
      const price = Number($('price').value) || (p? p.price : 0);
      addSale(itemName, qty, price, {productId: pid, cat: p? p.cat: ''});
      alert('Transaksi penjualan tersimpan.'); $('itemName').value=''; $('qty').value=1; $('price').value=1500;
    } else {
      const desc = $('expDesc').value.trim() || 'Pengeluaran';
      const cat = $('expCat').value;
      const amount = Number($('expAmount').value) || 0;
      addExpense(desc, cat, amount);
      alert('Pengeluaran tersimpan.'); $('expDesc').value=''; $('expAmount').value=50000;
    }
  });

  btnQuick.addEventListener('click', ()=>{
    const pid = productSelect.value; const p = products.find(x=>x.id===pid);
    if(!p) return alert('Pilih produk dulu');
    addSale(p.name,1,p.price,{productId:pid,cat:p.cat});
    alert('Tambah cepat berhasil.');
  });

  btnStockIn.addEventListener('click', ()=>{
    const pid = productSelect.value; const qty = Number(prompt('Jumlah stok masuk', '10')||0);
    if(qty<=0) return;
    const p = products.find(x=>x.id===pid); if(!p) return;
    p.stock = (p.stock||0) + qty; setStore(PRODUCTS, products); renderProducts();
    tx.push({type:'expense', desc:'Stok masuk '+p.name+' x'+qty, cat:'Stok', amount:0, t:nowISO()}); setStore(TX,tx); renderLedger('all');
    alert('Stok ditambahkan');
  });

  // export CSV
  btnExportCSV.addEventListener('click', ()=>{
    tx = getStore(TX, []);
    if(!tx.length) return alert('Tidak ada data untuk diexport');
    const rows = [['tanggal','tipe','keterangan','kategori','debit','kredit']];
    tx.forEach(t=> {
      if(t.type==='sale') rows.push([new Date(t.t).toLocaleString(),'Penjualan', t.item, t.cat||'', t.total, '']);
      else rows.push([new Date(t.t).toLocaleString(),'Pengeluaran', t.desc, t.cat||'', '', t.amount]);
    });
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}), url = URL.createObjectURL(blob), a = document.createElement('a');
    a.href = url; a.download = `copycenter_data_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
  });

  // export stock
  btnExportStock.addEventListener('click', ()=>{
    products = getStore(PRODUCTS, []);
    if(!products.length) return alert('Tidak ada stok');
    const rows = [['id','nama','kategori','harga','stok']];
    products.forEach(p => rows.push([p.id,p.name,p.cat,p.price,p.stock]));
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}), url = URL.createObjectURL(blob), a = document.createElement('a');
    a.href = url; a.download = `copycenter_stock_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
  });

  // import csv simple
  btnImportCSV.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    // minimal parse by lines, then comma-split (robust CSV not required here)
    const lines = txt.split(/\r?\n/).filter(Boolean);
    if(lines.length<2) return alert('CSV kosong atau tidak valid');
    const header = lines[0].toLowerCase();
    if(header.includes('nama') && header.includes('stok')){
      // treat as stock import
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(',');
        if(cols.length<3) continue;
        const id = cols[0].replace(/["]/g,'').trim() || ('p'+Math.random().toString(36).slice(2,8));
        const name = cols[1].replace(/["]/g,'').trim();
        const cat = cols[2].replace(/["]/g,'').trim();
        const price = Number((cols[3]||'0').replace(/["]/g,'').trim());
        const stock = Number((cols[4]||'0').replace(/["]/g,'').trim());
        const ex = products.find(x=>x.id===id || x.name===name);
        if(ex){ ex.name=name; ex.cat=cat; ex.price=price; ex.stock=stock; } else products.push({id,name,cat,price,stock});
      }
      setStore(PRODUCTS, products); renderProducts(); alert('Import stok selesai');
    } else {
      // treat as tx import (best effort)
      alert('Import transaksi belum didukung penuh di mode ini. Gunakan export CSV dari aplikasi.')
    }
  });

  // backup
  btnBackup.addEventListener('click', ()=>{
    const payload = {products:getStore(PRODUCTS,[]), tx:getStore(TX,[]), settings:getStore(SETTINGS,{})};
    const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `copycenter_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
  });

  // print pdf simple
  btnPrintPDF.addEventListener('click', ()=>{
    tx = getStore(TX,[]);
    const rows = tx.map(t=>`<tr><td>${new Date(t.t).toLocaleString()}</td><td>${t.type==='sale'?t.item:t.desc}</td><td>${t.type==='sale'?money(t.total):''}</td><td>${t.type==='expense'?money(t.amount):''}</td></tr>`).join('');
    const html = `<html><head><title>Laporan</title><style>body{font-family:Arial;padding:10px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:6px}</style></head><body><h2>Copycenter - Laporan</h2><table><thead><tr><th>Tanggal</th><th>Keterangan</th><th>Debit</th><th>Kredit</th></tr></thead><tbody>${rows}</tbody></table><script>window.onload=()=>setTimeout(()=>window.print(),300)</script></body></html>`;
    const w = window.open('','_blank'); w.document.write(html); w.document.close();
  });

  // POS modal
  let cart = [];
  openPOS.addEventListener('click', ()=>{ posModal.style.display='flex'; renderPOS(); });
  posClose.addEventListener('click', ()=>{ posModal.style.display='none'; cart = []; renderPOS(); });
  posAdd.addEventListener('click', ()=>{
    const pid = posProduct.value; const qty = Number(posQty.value)||1; const p = products.find(x=>x.id===pid); if(!p) return;
    cart.push({id:pid,name:p.name,qty,price:p.price}); renderPOS();
  });
  function renderPOS(){
    posProduct.innerHTML = products.map(p=>`<option value="${p.id}">${p.name} — ${money(p.price)}</option>`).join('');
    posCart.innerHTML = cart.map((c,i)=>`<tr><td>${c.name}</td><td>${c.qty}</td><td>${money(c.price)}</td><td>${money(c.qty*c.price)}</td><td><button class="small ghost remove-cart" data-i="${i}">Hapus</button></td></tr>`).join('');
    const total = cart.reduce((s,c)=>s + c.qty*c.price, 0); posTotal.textContent = money(total);
  }
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('remove-cart')){
      const i = Number(e.target.dataset.i); cart.splice(i,1); renderPOS();
    }
  });
  posCheckout.addEventListener('click', ()=>{
    if(!cart.length) return alert('Keranjang kosong');
    cart.forEach(c=> addSale(c.name,c.qty,c.price,{productId:c.id}));
    alert('Transaksi selesai.'); cart = []; renderPOS(); posModal.style.display='none';
  });
  posPrint.addEventListener('click', ()=>{ if(!cart.length) return alert('Keranjang kosong'); /* print as in previous code */ alert('Mencetak struk...'); });

  // txType toggle
  txType.addEventListener('change', ()=> {
    if(txType.value === 'sale'){ saleFields.style.display='block'; expenseFields.style.display='none'; }
    else { saleFields.style.display='none'; expenseFields.style.display='block'; }
  });

  // initial render
  renderProducts(); renderLedger('all'); renderSummary();

  // expose small API for debug
  window.CC = { renderProducts, renderLedger, renderSummary, addSale, addExpense };

})();
</script>
