<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Copycenter Antar Kita — Pencatatan Lengkap (PRO)</title>
<style>
  :root{
    --bg:#eef8f5; --card:#ffffff; --accent:#0b5a53; --accent-weak:#e8f6f4;
    --muted:#6b7280; --danger:#ef4444; --success:#16a34a;
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#ffffff);color:#0f172a}
  .wrap{max-width:1200px;margin:18px auto;padding:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  header h1{margin:0;font-size:20px}
  header p{margin:0;color:var(--muted);font-size:13px}
  .top-actions{display:flex;gap:8px;align-items:center}
  button, .btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid #e6e9ef;color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  @media(max-width:980px){.grid{grid-template-columns:1fr} .sidebar{display:none}}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(12,15,30,0.06)}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
  .row{display:flex;gap:10px}
  .row .col{flex:1}
  .totals{display:flex;gap:12px;margin-top:12px}
  .stat{flex:1;padding:16px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);text-align:center}
  .stat h3{margin:0;font-size:14px;color:var(--muted)}
  .stat p{margin:8px 0 0;font-weight:700}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:13px;text-align:left}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px;padding:6px 8px;border-radius:8px}
  .danger{background:var(--danger)}
  .success{background:var(--success)}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  /* sidebar */
  .sidebar{width:220px;position:fixed;left:18px;top:40px;padding:18px;border-radius:12px;background:linear-gradient(180deg,#0b5a53,#0a4b44);color:#fff;min-height:80vh}
  .sidebar h2{margin:0;font-size:18px}
  .nav{margin-top:18px}
  .nav button{display:block;width:100%;text-align:left;background:transparent;border:0;color:#bfe9e3;padding:10px;border-radius:8px;margin-bottom:6px;cursor:pointer}
  .nav button.active{background:rgba(255,255,255,0.08);color:#fff;border:1px solid rgba(255,255,255,0.06)}
  .pos-btn{display:block;margin-top:18px;background:#083f3b;color:#fff;padding:10px;border-radius:8px;border:0}
  /* modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(12,15,30,0.45);z-index:50}
  .modal .box{width:720px;max-width:95%;background:#fff;padding:18px;border-radius:10px;max-height:90vh;overflow:auto}
  .close{float:right;background:transparent;border:0;font-weight:700;cursor:pointer}
  /* ledger quick */
  .ledger-range{display:flex;gap:8px;align-items:center}
  .chart-wrap{height:160px;border-radius:8px;border:1px dashed #e6e9ef;padding:8px}
  .footer-note{font-size:12px;color:var(--muted);margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Copycenter Antar Kita — Pencatatan Lengkap (PRO)</h1>
      <p>Penjualan (fotokopi/print/pas foto/ATK/minuman), pengeluaran, stok, laporan & backup.</p>
    </div>
    <div class="top-actions">
      <button id="btnExport">Export CSV</button>
      <button id="btnExportStock" class="btn ghost">Export Stok</button>
      <button id="btnImport" class="btn ghost">Import CSV</button>
      <button id="btnBackup" class="btn">Download Backup</button>
      <button id="btnPrint" class="btn ghost">Cetak PDF</button>
      <button id="btnLogout" class="btn ghost">Logout</button>
      <input id="fileInput" type="file" accept=".csv,.json" style="display:none" />
    </div>
  </header>

  <div style="display:flex;gap:18px">
    <!-- left / main -->
    <div style="flex:1">
      <div class="card">
        <h3>Tambah Transaksi</h3>
        <div class="row" style="margin-top:8px">
          <div class="col">
            <label>Jenis</label>
            <select id="txType">
              <option value="sale">Penjualan (fotokopi / print / produk)</option>
              <option value="expense">Pengeluaran</option>
            </select>
          </div>
          <div class="col">
            <label>Filter Kategori</label>
            <select id="filterCategory">
              <option value="all">Semua</option>
            </select>
          </div>
        </div>

        <div id="saleFields" style="margin-top:12px">
          <label>Produk / Layanan</label>
          <select id="productSelect"><option value="">— pilih produk —</option></select>

          <label style="margin-top:8px">Nama Item / Layanan</label>
          <input id="itemName" placeholder="Contoh: Fotokopi A4 (1 lembar)" />

          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Jumlah</label>
              <input id="qty" type="number" min="1" value="1"/>
            </div>
            <div class="col">
              <label>Harga per Unit (Rp)</label>
              <input id="price" type="number" min="0" value="1500"/>
            </div>
          </div>
        </div>

        <div id="expenseFields" style="display:none;margin-top:12px">
          <label>Deskripsi Pengeluaran</label>
          <input id="expDesc" placeholder="Contoh: Kertas A4" />
          <label style="margin-top:8px">Kategori</label>
          <input id="expCat" placeholder="Operasional / Perlengkapan / Lainnya" />
          <label style="margin-top:8px">Jumlah (Rp)</label>
          <input id="expAmount" type="number" min="0" value="50000" />
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnAddTx">Tambah</button>
          <button id="btnQuick" class="btn ghost">Tambah Cepat (Rp 1.500 x 1)</button>
          <button id="btnStockIn" class="btn ghost">Stok Masuk</button>
        </div>

        <div class="totals">
          <div class="stat"><h3>Total Pemasukan</h3><p id="totalIncome">Rp 0</p></div>
          <div class="stat"><h3>Total Pengeluaran</h3><p id="totalExpense">Rp 0</p></div>
          <div class="stat"><h3>Keuntungan</h3><p id="totalProfit">Rp 0</p></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Daftar Produk & Stok</h3>
        <table id="productTable">
          <thead><tr><th>Produk</th><th>Kategori</th><th>Harga</th><th>Stok</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btnManageProducts" class="btn ghost">Kelola Produk</button>
          <button id="btnAddSample" class="btn ghost">Tambah Contoh</button>
        </div>
      </div>
    </div>

    <!-- right / ledger -->
    <aside class="card" style="width:360px">
      <h3>Buku Kas / Ledger</h3>
      <div style="margin-top:8px" class="ledger-range">
        <label style="margin:0">Tampilkan</label>
        <select id="ledgerRange" style="margin-left:8px">
          <option value="daily">Harian</option>
          <option value="weekly">Mingguan</option>
        </select>
      </div>

      <div style="margin-top:12px;max-height:420px;overflow:auto">
        <table id="ledgerTable">
          <thead><tr><th>Tgl</th><th>Keterangan</th><th>Debit</th><th>Kredit</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="chart-wrap" style="margin-top:12px">
        <canvas id="salesChart" width="320" height="140"></canvas>
      </div>

      <div class="footer-note">Data transaksi & stok tersimpan di browser (localStorage). Backup via Download Backup.</div>
    </aside>
  </div>
</div>

<!-- MODALS -->
<div id="modalProducts" class="modal"><div class="box">
  <button class="close" onclick="closeModal('modalProducts')">✕</button>
  <h3>Kelola Produk</h3>
  <div id="prodForm" style="margin-top:8px">
    <label>Nama Produk</label><input id="newProdName" />
    <label style="margin-top:8px">Kategori</label><input id="newProdCat" />
    <label style="margin-top:8px">Harga (Rp)</label><input id="newProdPrice" type="number" />
    <label style="margin-top:8px">Stok awal</label><input id="newProdStock" type="number" value="0" />
    <div style="margin-top:8px"><button id="btnAddProduct">Tambah Produk</button></div>
  </div>
  <div style="margin-top:12px">
    <h4>Daftar</h4>
    <table id="manageProductTable"><thead><tr><th>Nama</th><th>Kategori</th><th>Harga</th><th>Stok</th><th></th></tr></thead><tbody></tbody></table>
  </div>
</div></div>

<div id="modalPOS" class="modal"><div class="box">
  <button class="close" onclick="closeModal('modalPOS')">✕</button>
  <h3>Kasir (POS)</h3>
  <div style="display:flex;gap:12px">
    <div style="flex:1">
      <label>Pilih Produk</label>
      <select id="posProduct"><option value="">— pilih —</option></select>
      <label style="margin-top:8px">Jumlah</label>
      <input id="posQty" type="number" value="1" />
      <div style="margin-top:8px">
        <button id="btnAddPosItem" class="btn">Tambah ke Keranjang</button>
      </div>
    </div>
    <div style="flex:1">
      <h4>Keranjang</h4>
      <table id="posTable"><thead><tr><th>Item</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead><tbody></tbody></table>
      <div style="margin-top:8px" class="flex-between"><strong>Total:</strong><strong id="posTotal">Rp 0</strong></div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnCheckout" class="btn success">Bayar & Simpan</button>
        <button onclick="clearPos()" class="btn ghost">Batal</button>
      </div>
    </div>
  </div>
</div></div>

<input type="file" id="importFile" style="display:none" />

<script>
/* ===========================
   Simple PRO Copycenter App
   Single-file, localStorage-based
   =========================== */

/* Utility */
const $ = id => document.getElementById(id)
const formatIDR = v => 'Rp ' + Number(v||0).toLocaleString('id-ID')

/* Data keys */
const KEY_DATA = 'cc_data_tx'
const KEY_PROD = 'cc_products'
const KEY_PIN = 'cc_pin'
const KEY_PIN_ENABLED = 'cc_pin_enabled'
const KEY_AUTH = 'cc_auth'

/* Default seed */
const defaultProducts = [
  {id:uid(),name:'Fotokopi B/W',cat:'Fotokopi',price:1500,stock:0},
  {id:uid(),name:'Fotokopi Warna',cat:'Fotokopi',price:4000,stock:0},
  {id:uid(),name:'Print Pas Foto',cat:'Fotokopi',price:20000,stock:0},
  {id:uid(),name:'Pulpen',cat:'ATK',price:3000,stock:0},
  {id:uid(),name:'Buku Tulis',cat:'ATK',price:6000,stock:0}
]

/* State */
let data = load(KEY_DATA) || []
let products = load(KEY_PROD) || defaultProducts.slice()
let chartSales = null

/* Helpers */
function uid(){ return Math.random().toString(36).slice(2,9) }
function save(key, v){ localStorage.setItem(key, JSON.stringify(v)) }
function load(key){ try{return JSON.parse(localStorage.getItem(key))}catch(e){return null} }
function saveAll(){ save(KEY_DATA,data); save(KEY_PROD,products); }
function nowIso(){ return new Date().toISOString() }

/* Init */
document.addEventListener('DOMContentLoaded', _=>{
  initUI()
  renderAll()
  attachEvents()
})

/* UI init */
function initUI(){
  // populate product selects & categories
  renderProductOptions()
  renderFilterCategories()
  // set PIN default
  if(!localStorage.getItem(KEY_PIN)) localStorage.setItem(KEY_PIN,'1234')
}

/* Attach DOM events */
function attachEvents(){
  $('txType').addEventListener('change', e=>{
    const v=e.target.value
    $('saleFields').style.display = v==='sale' ? 'block' : 'none'
    $('expenseFields').style.display = v==='expense' ? 'block' : 'none'
  })

  $('btnAddTx').addEventListener('click', addTransaction)
  $('btnQuick').addEventListener('click', ()=>{
    $('txType').value='sale'; $('txType').dispatchEvent(new Event('change'))
    $('itemName').value='Fotokopi (1 lembar)'; $('qty').value=1; $('price').value=1500
    addTransaction()
  })

  $('btnManageProducts').addEventListener('click', ()=>openModal('modalProducts'))
  $('btnAddProduct').addEventListener('click', ()=>{
    const n=$('newProdName').value.trim(); if(!n) return alert('Isi nama produk')
    const p={id:uid(),name:n,cat:$('newProdCat').value.trim()||'Lainnya',price: Number($('newProdPrice').value)||0,stock: Number($('newProdStock').value)||0}
    products.push(p); saveAll(); renderAll(); renderManageProducts()
    $('newProdName').value=''; $('newProdCat').value=''; $('newProdPrice').value=''; $('newProdStock').value=0
  })

  $('btnAddSample').addEventListener('click', ()=>{
    defaultProducts.forEach(d=>{ d.id=uid(); products.push(Object.assign({},d)) })
    saveAll(); renderAll()
  })

  $('btnExport').addEventListener('click', exportCSV)
  $('btnExportStock').addEventListener('click', exportStockCSV)
  $('btnImport').addEventListener('click', ()=>$('fileInput').click())
  $('fileInput').addEventListener('change', handleImportFile)
  $('btnBackup').addEventListener('click', downloadBackup)
  $('btnPrint').addEventListener('click', ()=>window.print())
  $('btnLogout').addEventListener('click', ()=>{ localStorage.removeItem(KEY_AUTH); location.reload() })

  $('ledgerRange').addEventListener('change', ()=>renderLedger())

  // Manage products modal table render
  renderManageProducts()

  // POS wiring
  $('btnStockIn').addEventListener('click', ()=>openModal('modalPOS'))
  $('btnAddPosItem').addEventListener('click', addPosItem)
  $('btnCheckout').addEventListener('click', checkoutPos)

  // product select change to autofill price
  $('productSelect').addEventListener('change', e=>{
    const pid=e.target.value; if(!pid){ $('itemName').value=''; return }
    const p=products.find(x=>x.id===pid)
    if(p){ $('itemName').value=p.name; $('price').value=p.price }
  })

  // POS product select
  $('posProduct').addEventListener('change', e=>{
    const p=products.find(x=>x.id===e.target.value)
    if(p) $('posQty').value=1
  })
}

/* Render all sections */
function renderAll(){
  renderProductTable()
  renderProductOptions()
  renderFilterCategories()
  renderTotals()
  renderLedger()
  renderChart()
}

/* TRANSACTIONS */
function addTransaction(){
  const type = $('txType').value
  if(type==='sale'){
    const item = $('itemName').value.trim() || 'Penjualan'
    const qty = Number($('qty').value) || 1
    const price = Number($('price').value) || 0
    const total = qty*price
    const pId = $('productSelect').value
    // reduce stock if product chosen
    if(pId){
      const prod = products.find(x=>x.id===pId)
      if(prod){ prod.stock = (Number(prod.stock)||0) - qty; if(prod.stock<0) prod.stock=0 }
      save(KEY_PROD,products)
    }
    data.push({id:uid(),type:'sale',item,qty,price,total,t:nowIso(),cat:(pId? (products.find(x=>x.id===pId)||{}).cat : '')})
  } else {
    const desc = $('expDesc').value.trim() || 'Pengeluaran'
    const cat = $('expCat').value.trim() || 'Lainnya'
    const amount = Number($('expAmount').value) || 0
    data.push({id:uid(),type:'expense',desc,cat,amount,t:nowIso()})
  }
  saveAll(); renderAll(); alert('Transaksi tersimpan')
  // clear quick fields
  $('itemName').value=''; $('qty').value=1; $('price').value=1500; $('expDesc').value=''; $('expAmount').value=50000
}

/* PRODUCT rendering */
function renderProductTable(){
  const tbody = document.querySelector('#productTable tbody'); tbody.innerHTML=''
  products.forEach(p=>{
    const tr=document.createElement('tr')
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.cat)}</td><td>${formatIDR(p.price)}</td><td>${p.stock}</td>
      <td><button data-id="${p.id}" class="btn ghost small edit">Edit</button> <button data-id="${p.id}" class="btn ghost small del">Hapus</button></td>`
    tbody.appendChild(tr)
  })
  // attach handlers
  tbody.querySelectorAll('button.edit').forEach(b=>{
    b.addEventListener('click', e=>{
      const id=e.currentTarget.dataset.id
      const p=products.find(x=>x.id===id); if(!p) return
      const nm=prompt('Nama produk',p.name); if(!nm) return
      p.name=nm; p.cat=prompt('Kategori',p.cat)||p.cat; p.price=Number(prompt('Harga',p.price)||p.price)
      p.stock=Number(prompt('Stok',p.stock)||p.stock)
      saveAll(); renderAll(); renderManageProducts()
    })
  })
  tbody.querySelectorAll('button.del').forEach(b=>{
    b.addEventListener('click', e=>{
      const id=e.currentTarget.dataset.id
      if(confirm('Hapus produk?')){ products = products.filter(x=>x.id!==id); saveAll(); renderAll(); renderManageProducts() }
    })
  })
}

function renderProductOptions(){
  const sel = $('productSelect'); sel.innerHTML = '<option value="">— pilih produk —</option>'
  const pos = $('posProduct'); pos.innerHTML = '<option value="">— pilih produk —</option>'
  const catSet = new Set()
  products.forEach(p=>{
    const opt = document.createElement('option'); opt.value=p.id; opt.textContent = `${p.name} — Rp ${Number(p.price).toLocaleString('id-ID')}`
    sel.appendChild(opt)
    const opt2 = opt.cloneNode(true); pos.appendChild(opt2)
    catSet.add(p.cat||'Lainnya')
  })
  // also add categories to manage filter
  const fc=$('filterCategory'); fc.innerHTML='<option value="all">Semua</option>'
  Array.from(catSet).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; fc.appendChild(o)})
}

/* Manage products modal */
function renderManageProducts(){
  const tb = document.querySelector('#manageProductTable tbody'); tb.innerHTML=''
  products.forEach(p=>{
    const tr=document.createElement('tr')
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.cat)}</td><td>${formatIDR(p.price)}</td><td>${p.stock}</td>
      <td><button class="btn ghost small" data-id="${p.id}">Edit</button></td>`
    tb.appendChild(tr)
  })
  tb.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', e=>{
      const id=e.currentTarget.dataset.id; const p=products.find(x=>x.id===id)
      if(!p) return
      const nm=prompt('Nama',p.name); if(!nm) return
      p.name=nm; p.cat=prompt('Kategori',p.cat)||p.cat; p.price=Number(prompt('Harga',p.price)||p.price); p.stock=Number(prompt('Stok',p.stock)||p.stock)
      saveAll(); renderAll(); renderManageProducts()
    })
  })
}

/* LEDGER */
function renderLedger(){
  const tbody = document.querySelector('#ledgerTable tbody'); tbody.innerHTML=''
  const range = $('ledgerRange').value
  // filter rows based on daily/weekly
  const today = new Date()
  let rows = data.slice().reverse()
  if(range==='daily'){
    rows = rows.filter(tx=>{
      const d=new Date(tx.t); return d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate()
    })
  } else if(range==='weekly'){
    const oneWeekAgo = new Date(); oneWeekAgo.setDate(today.getDate()-6)
    rows = rows.filter(tx=> new Date(tx.t) >= oneWeekAgo )
  }
  rows.forEach(tx=>{
    const tr=document.createElement('tr')
    const date = new Date(tx.t).toLocaleString()
    let desc='', debit='', credit=''
    if(tx.type==='sale'){ desc = `${tx.item} (x${tx.qty||1})`; debit = formatIDR(tx.total); }
    else { desc = `${tx.desc||'Pengeluaran'} — ${tx.cat||''}`; credit = formatIDR(tx.amount) }
    tr.innerHTML = `<td>${date}</td><td>${escapeHtml(desc)}</td><td>${debit}</td><td>${credit}</td>`
    tbody.appendChild(tr)
  })
  renderTotals()
  renderChart()
}

/* totals */
function renderTotals(){
  let inc=0, exp=0
  data.forEach(tx=>{ if(tx.type==='sale') inc += Number(tx.total||0); if(tx.type==='expense') exp += Number(tx.amount||0) })
  $('totalIncome').textContent = formatIDR(inc)
  $('totalExpense').textContent = formatIDR(exp)
  $('totalProfit').textContent = formatIDR(inc-exp)
}

/* EXPORT CSV */
function exportCSV(){
  if(!data.length) return alert('Tidak ada data untuk diexport.')
  const rows=[['tanggal','tipe','keterangan','debit','kredit']]
  data.forEach(tx=>{
    if(tx.type==='sale') rows.push([new Date(tx.t).toLocaleString(),'Penjualan',`${tx.item} x${tx.qty}`,tx.total,''])
    else rows.push([new Date(tx.t).toLocaleString(),'Pengeluaran',`${tx.desc} (${tx.cat})`,'',tx.amount])
  })
  const csv = rows.map(r=> r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n')
  downloadBlob(csv, `copycenter_data_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv')
}

/* EXPORT STOCK */
function exportStockCSV(){
  if(!products.length) return alert('Tidak ada produk.')
  const rows=[['nama','kategori','harga','stok']]
  products.forEach(p=> rows.push([p.name,p.cat,p.price,p.stock]))
  const csv = rows.map(r=> r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n')
  downloadBlob(csv, `copycenter_stock_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv')
}

/* IMPORT (CSV or JSON backup) */
function handleImportFile(e){
  const f=e.target.files[0]; if(!f) return
  const name=f.name.toLowerCase()
  f.text().then(text=>{
    if(name.endsWith('.json')){
      try{
        const obj=JSON.parse(text)
        if(confirm('Ganti semua data dengan backup? (OK = Ganti, Cancel = Tambah/Merge)')){
          data = obj.data||[]
          products = obj.products||products
        } else {
          data = data.concat(obj.data||[])
          products = products.concat(obj.products||[])
        }
        saveAll(); renderAll(); alert('Backup diimport')
      }catch(err){ alert('Format JSON tidak valid') }
    } else if(name.endsWith('.csv')){
      const rows = parseCSV(text)
      if(rows.length<2) return alert('CSV kosong atau format tidak sesuai')
      const header = rows[0].map(h=>h.trim().toLowerCase())
      const idx = {t:0,type:1,desc:2,debit:3,credit:4}
      for(let i=1;i<rows.length;i++){
        const r=rows[i]
        const type=(r[idx.type]||'').toLowerCase()
        if((r[idx.debit]||'').trim()){
          // sale
          const t = new Date(r[idx.t]||new Date()).toISOString()
          const desc = r[idx.desc]||'Penjualan'
          const debit = Number((r[idx.debit]||'').replace(/[^0-9]/g,''))||0
          data.push({id:uid(),type:'sale',item:desc,qty:1,price:debit,total:debit,t})
        } else if((r[idx.credit]||'').trim()){
          const t = new Date(r[idx.t]||new Date()).toISOString()
          const desc = r[idx.desc]||'Pengeluaran'
          const credit = Number((r[idx.credit]||'').replace(/[^0-9]/g,''))||0
          data.push({id:uid(),type:'expense',desc,cat:'Lainnya',amount:credit,t})
        }
      }
      saveAll(); renderAll(); alert('Import CSV selesai')
    } else alert('Format file tidak didukung')
    e.target.value=''
  })
}

/* DOWNLOAD BACKUP JSON */
function downloadBackup(){
  const payload = {data,products,createdAt: new Date().toISOString()}
  downloadBlob(JSON.stringify(payload, null, 2), `copycenter_backup_${new Date().toISOString().slice(0,10)}.json`, 'application/json')
}

/* simple CSV parser */
function parseCSV(text){
  const rows=[]; let cur=''; let row=[]; let inQ=false
  for(let i=0;i<text.length;i++){
    const ch=text[i]; const nxt=text[i+1]
    if(ch==='"'){
      if(inQ && nxt==='"'){ cur+='"'; i++; continue }
      inQ=!inQ; continue
    }
    if(ch===',' && !inQ){ row.push(cur); cur=''; continue }
    if((ch==='\n' || ch==='\r') && !inQ){
      if(cur!=='' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur='' }
      continue
    }
    cur+=ch
  }
  if(cur!=='' || row.length>0){ row.push(cur); rows.push(row) }
  return rows
}

/* Download helper */
function downloadBlob(content, filename, type){
  const blob=new Blob([content],{type:type||'text/plain'}); const url=URL.createObjectURL(blob)
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
}

/* Product / modal helpers */
function openModal(id){ $(id).style.display='flex'; renderManageProducts() }
function closeModal(id){ $(id).style.display='none' }

/* POS functions */
let posItems=[]
function addPosItem(){
  const pid=$('posProduct').value; if(!pid) return alert('Pilih produk')
  const p=products.find(x=>x.id===pid); if(!p) return
  const qty=Number($('posQty').value)||1
  posItems.push({id:uid(),prod:pid,name:p.name,qty,price:p.price})
  renderPos()
}
function renderPos(){
  const tb=document.querySelector('#posTable tbody'); tb.innerHTML=''
  let total=0
  posItems.forEach(it=>{
    const tr=document.createElement('tr'); const sub=it.qty*it.price; total+=sub
    tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${it.qty}</td><td>${formatIDR(sub)}</td><td><button class="btn ghost small" data-id="${it.id}">Hapus</button></td>`
    tb.appendChild(tr)
  })
  tb.querySelectorAll('button').forEach(b=> b.addEventListener('click', e=>{
    posItems = posItems.filter(x=>x.id!==e.currentTarget.dataset.id); renderPos()
  }))
  $('posTotal').textContent = formatIDR(total)
}
function checkoutPos(){
  if(!posItems.length) return alert('Keranjang kosong')
  // create sale tx for each item
  posItems.forEach(it=>{
    data.push({id:uid(),type:'sale',item:it.name,qty:it.qty,price:it.price,total:it.qty*it.price,t:nowIso(),cat:(products.find(p=>p.id===it.prod)||{}).cat})
    // reduce stock
    const prod = products.find(p=>p.id===it.prod); if(prod) prod.stock = Math.max(0, (Number(prod.stock)||0) - it.qty)
  })
  posItems=[]
  saveAll(); renderAll(); renderPos(); closeModal('modalPOS'); alert('Transaksi POS tersimpan')
}
function clearPos(){ posItems=[]; renderPos() }

/* CHART (simple canvas) */
function renderChart(){
  const canvas = $('salesChart'); if(!canvas) return
  const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height)
  // compute last 7 days totals
  const days=7; const arr=Array(days).fill(0); const today=new Date()
  for(let i=0;i<data.length;i++){ const tx=data[i]; const d=new Date(tx.t); const diff = Math.floor((today - new Date(d.getFullYear(),d.getMonth(),d.getDate()))/(1000*60*60*24))
    if(diff>=0 && diff<days){
      if(tx.type==='sale') arr[days-1-diff] += Number(tx.total||0)
      if(tx.type==='expense') arr[days-1-diff] -= Number(tx.amount||0)
    }
  }
  const maxv = Math.max(1000, Math.max(...arr.map(x=>Math.abs(x))))
  // draw grid & bars
  const w=canvas.width, h=canvas.height; const pad=20; const gw=(w-2*pad)/days
  // grid
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,w,h)
  ctx.strokeStyle='#f1f5f4'; ctx.beginPath()
  for(let i=0;i<=4;i++){ const y = pad + i*(h-2*pad)/4; ctx.moveTo(pad,y); ctx.lineTo(w-pad,y) }
  ctx.stroke()
  // bars
  for(let i=0;i<days;i++){
    const val = arr[i]; const x = pad + i*gw + 8; const bh = (Math.abs(val)/maxv)*(h-2*pad)
    if(val>=0){ ctx.fillStyle='#16a34a' } else ctx.fillStyle='#ef4444'
    ctx.fillRect(x, h-pad-bh, gw-16, bh)
    // label
    ctx.fillStyle='#374151'; ctx.font='11px Inter'; const dt = new Date(); dt.setDate(dt.getDate()-(days-1-i)); ctx.fillText(dt.toLocaleDateString('id-ID',{day:'2-digit',month:'short'}), x, h-pad+12)
  }
}

/* misc helpers */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]) }

/* PIN & simple login guard (client-only) */
(function PIN_LOGIN(){
  // if auth set, continue
  if(!localStorage.getItem(KEY_AUTH)){
    // show login simple prompt
    const pin = prompt('Masukkan PIN (default 1234) untuk mengakses dashboard') || ''
    if(pin.trim() === (localStorage.getItem(KEY_PIN) || '1234')){
      localStorage.setItem(KEY_AUTH,'1')
    } else {
      alert('PIN salah. Halaman diblokir.')
      document.body.innerHTML = '<div style="padding:48px;font-family:Inter">Akses ditolak. Refresh untuk mencoba lagi.</div>'
      throw new Error('Auth failed')
    }
  }
})();

/* Utility: download sample */
function sampleSeed(){ products = defaultProducts.slice(); data=[]; saveAll(); renderAll() }

/* run initial render */
renderAll()

/* small safety: expose some helpers in console for debugging */
window.cc = { data, products, saveAll, renderAll, exportCSV, downloadBackup }

/* unexpected console-friendly patch display function (for debugging, ignore) */
function consolePatch(msg){ try{ console.log(msg) }catch(e){} }
</script>
</body>
</html>
