<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Copycenter Antar Kita - Pencatatan Lengkap</title>
  <style>
    :root{--bg:#f7f8fb;--card:#fff;--accent:#164e63;--muted:#6b7280}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;padding:18px;background:linear-gradient(180deg,#f3f4f6, #ffffff);color:#0f172a}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0}
    p.lead{margin:4px 0 18px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media(max-width:1100px){.grid{grid-template-columns:1fr} .actions-row{flex-wrap:wrap}}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(12,15,30,0.06)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    button{background:var(--accent);color:#fff;border:0;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #e6e9ef;color:var(--accent)}
    .totals{display:flex;gap:8px;flex-wrap:wrap}
    .stat{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);text-align:center}
    .stat h3{margin:0;font-size:16px}
    .stat p{margin:6px 0 0;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:13px;text-align:left}
    .muted{color:var(--muted);font-size:13px}
    .actions-row{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;padding:6px 8px;border-radius:8px}
    .danger{background:#ef4444}
    .success{background:#16a34a}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .controls{display:flex;gap:8px;align-items:center}
    .product-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    .badge{background:#eef6f7;padding:6px 8px;border-radius:8px;font-size:13px}
    .stock-table td, .stock-table th{font-size:13px}
    /* modal styling */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:30}
    .modal .box{width:820px;max-width:96%;background:#fff;padding:14px;border-radius:10px}
    .muted-small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Copycenter Antar Kita — Pencatatan Lengkap</h1>
        <p class="lead">Catat penjualan (fotokopi/print/pas foto/atk/rokok/minuman), pengeluaran, stok, laporan, dan backup.</p>
      </div>
      <div class="actions-row">
        <button id="btnExport" class="small">Export CSV</button>
        <button id="btnExportStock" class="small ghost">Export Stok</button>
        <button id="btnImport" class="small ghost">Import CSV</button>
        <button id="btnSettings" class="small ghost">Pengaturan</button>
        <input id="fileInput" type="file" accept=".csv" style="display:none" />
        <button id="btnClear" class="small ghost">Hapus Semua</button>
      </div>
    </header>

    <main class="grid" style="margin-top:14px">
      <section class="card">
        <div class="flex-between">
          <h2 style="font-size:16px;margin:0 0 12px">Tambah Transaksi</h2>
          <div class="controls">
            <label class="muted">Filter Kategori:</label>
            <select id="filterCategory"><option value="all">Semua</option></select>
            <label class="muted">Tipe:</label>
            <select id="filterType"><option value="all">Semua</option><option value="sale">Penjualan</option><option value="expense">Pengeluaran</option></select>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label>Produk (pilih cepat)</label>
          <div class="row" style="align-items:center">
            <select id="productSelect"></select>
            <button id="manageProducts" class="ghost small">Kelola Produk</button>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label>Jenis</label>
          <select id="type">
            <option value="sale">Penjualan (fotokopi / print / produk)</option>
            <option value="expense">Pengeluaran</option>
          </select>
        </div>

        <div id="saleForm">
          <label>Nama Item / Layanan</label>
          <input id="item" placeholder="Contoh: Fotokopi A4 (1 lembar)" />
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Jumlah</label>
              <input id="qty" type="number" min="1" value="1" />
            </div>
            <div class="col">
              <label>Harga per Unit (Rp)</label>
              <input id="price" type="number" min="0" value="1500" />
            </div>
          </div>
        </div>

        <div id="expenseForm" style="display:none">
          <label>Deskripsi Pengeluaran</label>
          <input id="expDesc" placeholder="Contoh: Kertas A4, Tinta" />
          <label style="margin-top:8px">Kategori</label>
          <select id="expCat">
            <option>Operasional</option>
            <option>Perlengkapan</option>
            <option>Gaji</option>
            <option>Lainnya</option>
          </select>
          <label style="margin-top:8px">Jumlah (Rp)</label>
          <input id="expAmount" type="number" min="0" value="50000" />
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnAdd">Tambah</button>
          <button id="btnAddQuick" class="ghost">Tambah Cepat (Rp 1.500 x 1)</button>
          <button id="btnStockIn" class="small ghost">Stok Masuk</button>
        </div>

        <div style="margin-top:12px" class="muted">Tips: pilih produk di dropdown untuk mengisi nama & harga otomatis. Gunakan Stok Masuk untuk menambah jumlah stok produk.</div>

        <div style="margin-top:18px">
          <h3 style="margin:0 0 8px">Ringkasan (berlaku pada filter saat ini)</h3>
          <div class="totals">
            <div class="stat"><h3>Pemasukan</h3><p id="totalIncome">Rp 0</p></div>
            <div class="stat"><h3>Pengeluaran</h3><p id="totalExpense">Rp 0</p></div>
            <div class="stat"><h3>Keuntungan</h3><p id="totalProfit">Rp 0</p></div>
          </div>
        </div>

        <div style="margin-top:18px" class="card">
          <h4 style="margin:0 0 8px">Daftar Produk & Stok</h4>
          <table class="stock-table" style="width:100%"><thead><tr><th>Produk</th><th>Kategori</th><th>Harga</th><th>Stok</th><th></th></tr></thead><tbody id="stockList"></tbody></table>
        </div>

        <div style="margin-top:12px" class="card">
          <h4 style="margin:0 0 8px">Laporan</h4>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="reportType"><option value="daily">Harian</option><option value="monthly">Bulanan</option></select>
            <input id="reportFrom" type="date" />
            <input id="reportTo" type="date" />
            <button id="btnGenerateReport" class="small ghost">Generate</button>
            <button id="btnExportReport" class="small ghost">Export Laporan</button>
          </div>
          <div style="margin-top:8px;max-height:220px;overflow:auto"><table id="reportTable"><thead></thead><tbody></tbody></table></div>
        </div>

      </section>

      <aside class="card">
        <h3 style="margin:0 0 10px">Buku Kas / Ledger</h3>
        <div style="max-height:420px;overflow:auto">
          <table id="ledger">
            <thead><tr><th>Tgl</th><th>Keterangan</th><th>Kategori</th><th>Debit</th><th>Kredit</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btnToday" class="small">Filter Hari Ini</button>
          <button id="btnAll" class="small ghost">Tampilkan Semua</button>
        </div>
        <footer>
          <div class="muted" style="margin-top:8px">Data transaksi & stok tersimpan di browser (localStorage). Backup pakai Export CSV.</div>
        </footer>
      </aside>
    </main>
  </div>

  <!-- Modal: Kelola Produk -->
  <div id="productModal" class="modal"><div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Kelola Produk</h3>
        <div>
          <button id="closeModal" class="small ghost">Tutup</button>
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <input id="newName" placeholder="Nama produk (contoh: Fotokopi B/W)" />
        <input id="newCat" placeholder="Kategori (contoh: Fotokopi)" />
        <input id="newPrice" type="number" placeholder="Harga (Rp)" />
        <input id="newStock" type="number" placeholder="Stok awal" />
        <button id="addProduct">Tambah</button>
      </div>
      <div style="margin-top:12px;max-height:300px;overflow:auto">
        <table style="width:100%"><thead><tr><th>Nama</th><th>Kategori</th><th>Harga</th><th>Stok</th><th></th></tr></thead><tbody id="productRows"></tbody></table>
      </div>
    </div></div>

  <!-- Modal: Settings (theme + deploy guide) -->
  <div id="settingsModal" class="modal"><div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">Pengaturan & Panduan Deploy</h3><button id="closeSettings" class="small ghost">Tutup</button></div>
    <div style="margin-top:12px">
      <label>Warna Tema (Accent)</label>
      <input id="themeColor" type="color" value="#164e63" />
      <div style="margin-top:8px" class="muted-small">Warna ini akan diterapkan untuk tombol utama. Tersimpan di browser.</div>
    </div>
    <hr />
    <div>
      <h4 style="margin:6px 0">Panduan singkat deploy ke GitHub Pages</h4>
      <ol class="muted-small">
        <li>Buat akun GitHub (jika belum) dan repo baru (misal: <code>copycenter-antar-kita</code>).</li>
        <li>Upload file <code>copycenter-antar-kita.html</code> ke repo (branch main).</li>
        <li>Settings → Pages → source: main branch → / (root). Simpan. Tunggu beberapa menit.</li>
        <li>Website akan tersedia di <code>https://&lt;username&gt;.github.io/copycenter-antar-kita/</code></li>
      </ol>
      <div style="margin-top:8px" class="muted-small">Atau paketkan ke Netlify/ Vercel: drag & drop file HTML ke dashboard, langsung live.</div>
    </div>
  </div></div>

  <script>
    // storage keys
    const TX_KEY = 'copycenter_data'
    const STOCK_KEY = 'copycenter_stock'
    const THEME_KEY = 'copycenter_theme'

    const $ = id=>document.getElementById(id)
    const ledgerTbody = document.querySelector('#ledger tbody')
    let data = JSON.parse(localStorage.getItem(TX_KEY)||'[]')
    let stock = JSON.parse(localStorage.getItem(STOCK_KEY)||'[]')

    // default products
    const defaultProducts = [
      {name:'Fotokopi B/W', cat:'Fotokopi', price:1500, qty:0},
      {name:'Fotokopi Warna', cat:'Fotokopi', price:4000, qty:0},
      {name:'Print Pas Foto', cat:'Fotokopi', price:20000, qty:0},
      {name:'Pulpen', cat:'ATK', price:3000, qty:0},
      {name:'Buku Tulis', cat:'ATK', price:6000, qty:0},
      {name:'Aqua 600ml', cat:'Minuman', price:5000, qty:0},
      {name:'Rokok Surya Besar', cat:'Rokok', price:36000, qty:0},
      {name:'Rokok Surya Kecil', cat:'Rokok', price:27000, qty:0}
    ]
    if(!stock.length) stock = defaultProducts.slice()

    // apply theme
    function applyTheme(){
      const t = localStorage.getItem(THEME_KEY) || '#164e63'
      document.documentElement.style.setProperty('--accent', t)
      $('themeColor').value = t
    }
    applyTheme()

    function saveAll(){ localStorage.setItem(TX_KEY, JSON.stringify(data)); localStorage.setItem(STOCK_KEY, JSON.stringify(stock)); render(); }

    function formatIDR(n){ if(!n && n!==0) return 'Rp 0'; return 'Rp '+Number(n).toLocaleString('id-ID') }
    function nowIso(){ return new Date().toISOString() }

    // populate product select and stock list
    function populateProducts(){
      const sel = $('productSelect')
      sel.innerHTML = ''
      stock.forEach((p,i)=>{ const opt = document.createElement('option'); opt.value = i; opt.textContent = `${p.name} — ${p.cat} — Rp ${p.price.toLocaleString()}`; sel.appendChild(opt) })
      // populate filter categories
      const cats = ['all', ...new Set(stock.map(s=>s.cat))]
      $('filterCategory').innerHTML = cats.map(c=>`<option value="${c}">${c=='all'? 'Semua' : c}</option>`).join('')
    }

    function renderStocks(){
      const tbody = $('stockList'); tbody.innerHTML = ''
      stock.forEach((p,i)=>{
        const tr = document.createElement('tr')
        tr.innerHTML = `<td>${p.name}</td><td>${p.cat}</td><td>${formatIDR(p.price)}</td><td>${p.qty}</td><td><button data-i='${i}' class='small ghost'>Tambah Stok</button></td>`
        tbody.appendChild(tr)
      })
      // stock row handlers
      tbody.querySelectorAll('button').forEach(b=> b.addEventListener('click', e=>{
        const i = Number(e.currentTarget.dataset.i)
        const add = prompt('Masukkan jumlah stok masuk untuk '+stock[i].name, '0')
        const num = Number(add)||0
        if(num>0){ stock[i].qty += num; saveAll(); }
      }))
    }

    function render(filterToday=false){
      ledgerTbody.innerHTML = ''
      let income=0, expense=0
      const catFilter = $('filterCategory').value
      const typeFilter = $('filterType').value
      const rows = data.filter(tx=>{
        if(filterToday){ const d=new Date(tx.t); const t=new Date(); if(!(d.getFullYear()==t.getFullYear() && d.getMonth()==t.getMonth() && d.getDate()==t.getDate())) return false }
        if(typeFilter!=='all' && tx.type!==typeFilter) return false
        if(catFilter!=='all' && ((tx.type==='sale' && (tx.cat||'')!==catFilter) && (tx.type==='expense' && (tx.cat||'')!==catFilter))) return false
        return true
      })
      rows.slice().reverse().forEach((tx,i)=>{
        const tr=document.createElement('tr')
        const date=new Date(tx.t)
        const desc = tx.type=='sale' ? `${tx.item} (x${tx.qty})` : `${tx.desc}`
        const cat = tx.cat || (tx.type=='sale'? (tx.pcat||'Produk') : 'Pengeluaran')
        const debit = tx.type=='sale' ? formatIDR(tx.total) : ''
        const credit = tx.type=='expense' ? formatIDR(tx.amount) : ''
        if(tx.type=='sale') income += Number(tx.total)
        if(tx.type=='expense') expense += Number(tx.amount)
        tr.innerHTML = `<td>${date.toLocaleString()}</td><td>${desc}</td><td>${cat}</td><td>${debit}</td><td>${credit}</td><td><button data-i='${data.length-1-i}' class='small ghost'>Hapus</button></td>`
        ledgerTbody.appendChild(tr)
      })
      $('totalIncome').textContent = formatIDR(income)
      $('totalExpense').textContent = formatIDR(expense)
      $('totalProfit').textContent = formatIDR(income-expense)

      ledgerTbody.querySelectorAll('button').forEach(b=> b.addEventListener('click', e=>{ const idx=Number(e.currentTarget.dataset.i); if(confirm('Hapus transaksi?')){ data.splice(idx,1); saveAll(); } }))
    }

    // initial
    populateProducts(); renderStocks(); render()

    // form logic
    $('productSelect').addEventListener('change', e=>{
      const p = stock[Number(e.target.value)]
      if(p){ $('item').value = p.name; $('price').value = p.price }
    })

    $('manageProducts').addEventListener('click', ()=>{ $('productModal').style.display='flex'; updateProductRows() })
    $('closeModal').addEventListener('click', ()=>{ $('productModal').style.display='none' })

    function updateProductRows(){ const tbody=$('productRows'); tbody.innerHTML=''; stock.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.name}</td><td>${p.cat}</td><td>${formatIDR(p.price)}</td><td>${p.qty}</td><td><button data-i='${i}' class='small ghost'>Edit</button> <button data-i='${i}' class='small ghost'>Hapus</button></td>`; tbody.appendChild(tr) });
      tbody.querySelectorAll('button').forEach(b=> b.addEventListener('click', e=>{
        const i=Number(e.currentTarget.dataset.i)
        if(e.currentTarget.textContent.trim()==='Hapus'){ if(confirm('Hapus produk?')){ stock.splice(i,1); populateProducts(); renderStocks(); updateProductRows(); saveAll(); } }
        else { const p=stock[i]; const newName=prompt('Nama produk',p.name); if(newName===null) return; const newCat=prompt('Kategori',p.cat); if(newCat===null) return; const newPrice=prompt('Harga (Rp)',p.price); if(newPrice===null) return; const newQty=prompt('Stok',p.qty); if(newQty===null) return; p.name=newName; p.cat=newCat; p.price=Number(newPrice)||p.price; p.qty=Number(newQty)||p.qty; populateProducts(); renderStocks(); updateProductRows(); saveAll(); } }))
    }

    $('addProduct').addEventListener('click', ()=>{
      const name=$('newName').value.trim(); const cat=$('newCat').value.trim()||'Lainnya'; const price=Number($('newPrice').value)||0; const qty=Number($('newStock').value)||0
      if(!name){ alert('Masukkan nama produk'); return }
      stock.push({name, cat, price, qty}); $('newName').value=''; $('newCat').value=''; $('newPrice').value=''; $('newStock').value=''; populateProducts(); renderStocks(); updateProductRows(); saveAll();
    })

    // toggle forms
    $('type').addEventListener('change', e=>{
      if(e.target.value=='sale'){ $('saleForm').style.display='block'; $('expenseForm').style.display='none' } else { $('saleForm').style.display='none'; $('expenseForm').style.display='block' }
    })

    // add tx
    function addTx(){
      const type=$('type').value
      if(type==='sale'){
        const item=$('item').value.trim()||'Penjualan'
        const qty=Number($('qty').value)||1
        const price=Number($('price').value)||0
        const total=qty*price
        // reduce stock if product exists
        const prodIndex = stock.findIndex(s=>s.name===item)
        if(prodIndex>=0){ if(stock[prodIndex].qty < qty){ if(!confirm('Stok produk kurang. Tetap lanjut? (Pilih Cancel untuk batalkan)')) return } stock[prodIndex].qty = Math.max(0, stock[prodIndex].qty - qty) }
        data.push({type:'sale', item, qty, price, total, t: nowIso(), cat: stock[prodIndex]?stock[prodIndex].cat:'Produk', pcat: stock[prodIndex]?stock[prodIndex].cat:''})
      } else {
        const desc=$('expDesc').value.trim()||'Pengeluaran'
        const cat=$('expCat').value
        const amount=Number($('expAmount').value)||0
        data.push({type:'expense', desc, cat, amount, t: nowIso()})
      }
      saveAll()
      // clear
      $('item').value=''; $('qty').value=1; $('price').value=1500; $('expDesc').value=''; $('expAmount').value=50000
    }

    $('btnAdd').addEventListener('click', addTx)
    $('btnAddQuick').addEventListener('click', ()=>{ $('type').value='sale'; $('type').dispatchEvent(new Event('change')); $('item').value='Fotokopi B/W'; $('qty').value=1; $('price').value=1500; addTx() })

    // stock in modal (simple prompt)
    $('btnStockIn').addEventListener('click', ()=>{
      const idx = $('productSelect').value
      const p = stock[Number(idx)]
      if(!p){ alert('Pilih produk untuk menambah stok'); return }
      const add = prompt('Masukkan jumlah stok masuk untuk '+p.name,'0')
      const n = Number(add)||0
      if(n>0){ p.qty += n; saveAll(); }
    })

    // export CSV (transactions only)
    function exportCSV(){
      if(!data.length){ alert('Tidak ada data untuk diexport.'); return }
      const rows = [['tanggal','tipe','keterangan','kategori','debit','kredit']]
      data.forEach(tx=>{
        const t = new Date(tx.t).toLocaleString()
        if(tx.type=='sale') rows.push([t,'Penjualan',tx.item + ' x'+tx.qty, tx.cat||'', tx.total,''])
        else rows.push([t,'Pengeluaran',tx.desc, tx.cat||'', '', tx.amount])
      })
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `copycenter_data_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    }
    $('btnExport').addEventListener('click', exportCSV)

    // export stock CSV
    function exportStockCSV(){
      if(!stock.length){ alert('Tidak ada stok untuk diexport.'); return }
      const rows = [['nama','kategori','harga','stok']]
      stock.forEach(s=> rows.push([s.name, s.cat, s.price, s.qty]))
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `copycenter_stock_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    }
    $('btnExportStock').addEventListener('click', exportStockCSV)

    // import CSV (transactions)
    $('btnImport').addEventListener('click', ()=>$('fileInput').click())
    $('fileInput').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return; const text = await f.text(); const rows = parseCSV(text).map(r=>r.map(c=>c.trim())); if(rows.length<2){ alert('File CSV kosong atau format tidak dikenali.'); return }
      const header = rows[0].map(h=>String(h||'').trim().toLowerCase().replace(/\s+/g,''))
      const idx = {}; header.forEach((h,i)=>{ if(['tanggal','date','tgl','time'].includes(h)) idx.t=i; if(['tipe','type'].includes(h)) idx.type=i; if(['keterangan','desc','keterangan','description'].includes(h)) idx.desc=i; if(['kategori','cat'].includes(h)) idx.cat=i; if(['debit','income','masuk'].includes(h)) idx.debit=i; if(['kredit','credit','expense','keluar'].includes(h)) idx.credit=i })
      if(idx.t===undefined) idx.t=0; if(idx.type===undefined) idx.type=1; if(idx.desc===undefined) idx.desc=2; if(idx.debit===undefined) idx.debit=4; if(idx.credit===undefined) idx.credit=5; if(idx.cat===undefined) idx.cat=3
      const replace = confirm('Apakah ingin MENGGANTI semua data yang ada sekarang? (OK = Ganti, Cancel = Tambah/Merge)')
      const imported=[]
      for(let i=1;i<rows.length;i++){ const r=rows[i]; if(r.length===0) continue; const tRaw=r[idx.t]||''; const typeRaw=(r[idx.type]||'').toLowerCase(); const descRaw=r[idx.desc]||''; const debitRaw=(r[idx.debit]||'').replace(/[^0-9\-\.]/g,''); const creditRaw=(r[idx.credit]||'').replace(/[^0-9\-\.]/g,''); let t=new Date(tRaw); if(isNaN(t)) t=new Date()
        if((debitRaw && Number(debitRaw)>0) || typeRaw.includes('penjualan') || typeRaw.includes('sale')){
          let item = descRaw; let qty = 1; const m = descRaw.match(/(.*)\s+x\s*(\d+)$/i); if(m){ item = m[1].trim(); qty = Number(m[2]) }
          const total = Number(debitRaw) || 0; let price = total; if(qty>0) price = qty? Math.round(total/qty) : total
          imported.push({type:'sale', item:item||'Penjualan', qty:qty||1, price:price||total, total:total, t:t.toISOString(), cat: r[idx.cat]||''})
        } else if((creditRaw && Number(creditRaw)>0) || typeRaw.includes('pengeluaran') || typeRaw.includes('expense')){
          const amount = Number(creditRaw) || 0; imported.push({type:'expense', desc:descRaw||'Pengeluaran', cat: r[idx.cat]||'Perlengkapan', amount:amount, t:t.toISOString()})
        } else continue
      }
      if(!imported.length){ alert('Tidak ada transaksi valid yang terdeteksi di file CSV.'); return }
      if(replace) data = imported; else data = data.concat(imported)
      saveAll(); alert('Import berhasil: '+imported.length+' transaksi.'); e.target.value=''
    })

    function parseCSV(text){ const rows=[]; let cur=''; let row=[]; let inQuotes=false; for(let i=0;i<text.length;i++){ const ch=text[i]; const nxt=text[i+1]; if(ch==='"'){ if(inQuotes && nxt==='"'){ cur+='"'; i++; continue } inQuotes=!inQuotes; continue } if(ch===',' && !inQuotes){ row.push(cur); cur=''; continue } if((ch==='\n' || ch==='\r') && !inQuotes){ if(cur!=='' || row.length>0){ row.push(cur); cur=''; rows.push(row); row=[] } continue } cur+=ch } if(cur!=='' || row.length>0){ row.push(cur); rows.push(row) } return rows }

    // report generation
    function generateReport(){
      const type = $('reportType').value
      let from = $('reportFrom').value ? new Date($('reportFrom').value) : null
      let to = $('reportTo').value ? new Date($('reportTo').value) : null
      if(from) from.setHours(0,0,0,0)
      if(to) to.setHours(23,59,59,999)
      const rows = data.slice()
      const map = {}
      rows.forEach(tx=>{
        const d = new Date(tx.t)
        if(from && d<from) return
        if(to && d>to) return
        let key
        if(type==='daily') key = d.toLocaleDateString()
        else key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0')
        if(!map[key]) map[key] = {income:0, expense:0}
        if(tx.type==='sale') map[key].income += Number(tx.total)
        if(tx.type==='expense') map[key].expense += Number(tx.amount)
      })
      // build table
      const thead = $('reportTable').querySelector('thead')
      const tbody = $('reportTable').querySelector('tbody')
      thead.innerHTML = `<tr><th>${type==='daily'?'Tanggal':'Bulan'}</th><th>Pemasukan</th><th>Pengeluaran</th><th>Keuntungan</th></tr>`
      tbody.innerHTML = ''
      Object.keys(map).sort().forEach(k=>{
        const row = map[k]
        const profit = row.income - row.expense
        const tr = document.createElement('tr')
        tr.innerHTML = `<td>${k}</td><td>${formatIDR(row.income)}</td><td>${formatIDR(row.expense)}</td><td>${formatIDR(profit)}</td>`
        tbody.appendChild(tr)
      })
    }
    $('btnGenerateReport').addEventListener('click', generateReport)

    // export report as CSV
    $('btnExportReport').addEventListener('click', ()=>{
      const rows = []
      const type = $('reportType').value
      const tbody = Array.from(document.querySelectorAll('#reportTable tbody tr'))
      if(!tbody.length){ alert('Generate laporan terlebih dahulu'); return }
      // header
      rows.push([ type==='daily' ? 'tanggal' : 'bulan', 'pemasukan', 'pengeluaran', 'keuntungan'])
      tbody.forEach(tr=>{
        const cols = Array.from(tr.querySelectorAll('td')).map(td=>td.textContent.replace(/Rp\s|\.|,/g,''))
        rows.push(cols)
      })
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `copycenter_report_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    })

    // clear
    $('btnClear').addEventListener('click', ()=>{ if(confirm('Yakin hapus semua data & stok? Ini tidak bisa dibatalkan.')){ data=[]; stock=[]; saveAll(); populateProducts(); renderStocks(); } })

    // filters
    $('btnToday').addEventListener('click', ()=>render(true))
    $('btnAll').addEventListener('click', ()=>render(false))
    $('filterCategory').addEventListener('change', ()=>render(false))
    $('filterType').addEventListener('change', ()=>render(false))

    // settings modal
    $('btnSettings').addEventListener('click', ()=>{ $('settingsModal').style.display='flex'; })
    $('closeSettings').addEventListener('click', ()=>{ $('settingsModal').style.display='none'; })
    $('themeColor').addEventListener('input', e=>{ localStorage.setItem(THEME_KEY, e.target.value); applyTheme() })

    // keep rendering if storage changed elsewhere
    window.addEventListener('storage', ()=>{ data = JSON.parse(localStorage.getItem(TX_KEY)||'[]'); stock = JSON.parse(localStorage.getItem(STOCK_KEY)||'[]'); populateProducts(); renderStocks(); render() })

    // helper save
    function saveAll(){ localStorage.setItem(TX_KEY, JSON.stringify(data)); localStorage.setItem(STOCK_KEY, JSON.stringify(stock)); populateProducts(); renderStocks(); render() }

  </script>
</body>
</html>
