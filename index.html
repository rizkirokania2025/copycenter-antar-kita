<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Copycenter Antar Kita — Pencatatan Lengkap (PRO)</title>
<style>
  :root{
    --bg:#ecf7f3;--card:#fff;--accent:#0b6b53;--muted:#6b7280;--panel:#f7fbfa;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:#0f172a}
  .app{max-width:1200px;margin:18px auto;padding:12px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .top-actions{display:flex;gap:8px}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--accent);font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px}
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 20px rgba(12,15,30,0.04)}
  label{display:block;color:var(--muted);margin-bottom:6px;font-size:13px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef0;font-size:14px}
  .row{display:flex;gap:8px}
  .row .col{flex:1}
  .totals{display:flex;gap:10px;margin-top:10px}
  .stat{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);text-align:center}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:13px;text-align:left}
  .muted{color:var(--muted);font-size:13px}
  /* sidebar small */
  .sidebar{width:220px;padding:12px;background:#0b6b53;color:#fff;border-radius:12px;position:fixed;left:18px;top:18px;height:calc(100% - 36px);box-shadow:0 8px 20px rgba(12,15,30,0.08)}
  .sidebar h2{margin:0;font-size:18px}
  .nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
  .nav button{background:transparent;border:0;color:#dff4ec;text-align:left;padding:10px;border-radius:8px;cursor:pointer}
  .nav button.active{background:rgba(255,255,255,0.06);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}
  .content{margin-left:260px}
  .small{font-size:13px;padding:6px 8px;border-radius:8px}
  .danger{background:#ef4444}
  .center{display:flex;align-items:center;justify-content:center}
  footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
  @media(max-width:980px){.sidebar{position:static;width:100%;height:auto;margin-bottom:12px}.content{margin-left:0}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:48px;height:48px;background:#fff;border-radius:8px;color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700">CC</div>
      <div>
        <div style="font-weight:700">Copycenter Antar Kita</div>
        <div style="font-size:13px;opacity:.9">Pencatatan & Kasir</div>
      </div>
    </div>
    <div class="nav" id="nav">
      <button data-target="page_dashboard" class="active">Dashboard</button>
      <button data-target="page_sales">Penjualan</button>
      <button data-target="page_products">Produk</button>
      <button data-target="page_reports">Laporan</button>
      <button data-target="page_settings">Pengaturan</button>
      <div style="margin-top:18px">
        <button id="openPosBtn" class="small" style="background:#fff;color:var(--accent);width:100%">Buka Kasir (POS)</button>
      </div>
    </div>
  </div>

  <div class="app content">
    <header>
      <div>
        <h1>Copycenter Antar Kita — Pencatatan Lengkap (PRO)</h1>
        <div class="muted">Penjualan (fotokopi/print/pas foto/atk/minuman), pengeluaran, stok, laporan & backup</div>
      </div>
      <div class="top-actions">
        <button id="btnExportCSV" class="small">Export CSV</button>
        <button id="btnExportStock" class="small ghost">Export Stok</button>
        <button id="btnImport" class="small ghost">Import CSV</button>
        <button id="btnDownloadBackup" class="small">Download Backup</button>
        <button id="btnPrint" class="small ghost">Cetak PDF</button>
        <button id="btnLogout" class="small ghost">Logout</button>
        <input id="fileInput" type="file" accept=".csv" style="display:none" />
      </div>
    </header>

    <main style="margin-top:12px;">
      <!-- PAGES -->
      <div id="page_dashboard" class="page">
        <div class="grid">
          <section class="card">
            <h3>Tambah Transaksi</h3>
            <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
              <div style="flex:1">
                <label>Jenis</label>
                <select id="txType">
                  <option value="sale">Penjualan (fotokopi / print / produk)</option>
                  <option value="expense">Pengeluaran</option>
                </select>
              </div>
              <div style="width:180px">
                <label>Filter Kategori</label>
                <select id="filterCategory"><option value="all">Semua</option></select>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Produk / Layanan</label>
              <select id="productSelect"><option>-- pilih produk --</option></select>
              <label style="margin-top:8px">Nama Item / Layanan</label>
              <input id="itemName" placeholder="Contoh: Fotokopi A4 (1 lembar)" />
              <div class="row" style="margin-top:8px">
                <div class="col">
                  <label>Jumlah</label>
                  <input id="qty" type="number" min="1" value="1" />
                </div>
                <div class="col">
                  <label>Harga per Unit (Rp)</label>
                  <input id="price" type="number" min="0" value="1500" />
                </div>
              </div>

              <div style="margin-top:10px;display:flex;gap:8px">
                <button id="btnAdd" class="small">Tambah</button>
                <button id="btnQuick" class="small ghost">Tambah Cepat (Rp 1.500 x 1)</button>
                <button id="btnStockIn" class="small ghost">Stok Masuk</button>
              </div>

              <div class="totals">
                <div class="stat"><div class="muted">Total Pemasukan</div><div id="totalIncome" style="font-weight:700;margin-top:6px">Rp 0</div></div>
                <div class="stat"><div class="muted">Total Pengeluaran</div><div id="totalExpense" style="font-weight:700;margin-top:6px">Rp 0</div></div>
                <div class="stat"><div class="muted">Keuntungan</div><div id="totalProfit" style="font-weight:700;margin-top:6px">Rp 0</div></div>
              </div>
            </div>

            <div style="margin-top:12px">
              <h4>Daftar Produk & Stok</h4>
              <table id="productsTable">
                <thead><tr><th>Produk</th><th>Kategori</th><th>Harga</th><th>Stok</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <aside class="card">
            <h3>Buku Kas / Ledger</h3>
            <label>Tampilkan</label>
            <select id="ledgerRange"><option value="daily">Harian</option><option value="weekly">Mingguan</option><option value="all">Semua</option></select>
            <table id="ledgerTable">
              <thead><tr><th>Tgl</th><th>Keterangan</th><th>Kategori</th><th>Debit</th><th>Kredit</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="muted" style="margin-top:8px">Data tersimpan di browser (localStorage). Gunakan Download Backup untuk menyimpan.</div>
          </aside>
        </div>
      </div>

      <!-- PAGE SALES (detail) -->
      <div id="page_sales" class="page" style="display:none;margin-top:12px">
        <div class="card">
          <h3>Penjualan — Tambah & Riwayat</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="searchSales" placeholder="Cari keterangan / item" style="flex:1"/>
            <select id="rangeSales"><option value="today">Hari ini</option><option value="week">Minggu</option><option value="month">Bulan</option></select>
            <button id="btnNewSale" class="small">+ Transaksi</button>
          </div>
          <div style="margin-top:12px">
            <table id="salesTable">
              <thead><tr><th>Tgl</th><th>Item</th><th>Qty</th><th>Total</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- PAGE PRODUCTS -->
      <div id="page_products" class="page" style="display:none;margin-top:12px">
        <div class="card">
          <h3>Produk — Stok & Harga</h3>
          <div style="display:flex;gap:8px">
            <input id="newProdName" placeholder="Nama produk"/>
            <input id="newProdCat" placeholder="Kategori" style="width:160px"/>
            <input id="newProdPrice" placeholder="Harga" type="number" style="width:120px"/>
            <input id="newProdStock" placeholder="Stok" type="number" style="width:80px"/>
            <button id="btnAddProduct">Tambah Produk</button>
          </div>
          <div style="margin-top:12px">
            <table id="prodTable">
              <thead><tr><th>Nama</th><th>Kategori</th><th>Harga</th><th>Stok</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- PAGE REPORTS -->
      <div id="page_reports" class="page" style="display:none;margin-top:12px">
        <div class="card">
          <h3>Laporan / Export</h3>
          <div style="display:flex;gap:8px">
            <button id="btnExportCSV2" class="small">Export CSV</button>
            <button id="btnDownloadBackup2" class="small">Download Backup (JSON)</button>
            <button id="btnPrint2" class="small ghost">Cetak</button>
          </div>
          <p class="muted" style="margin-top:8px">Gunakan Export untuk melihat data per bulan di Excel.</p>
        </div>
      </div>

      <!-- PAGE SETTINGS -->
      <div id="page_settings" class="page" style="display:none;margin-top:12px">
        <div class="card">
          <h3>Pengaturan</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <label style="width:160px">Ubah PIN (4 digit)</label>
            <input id="newPin" placeholder="1234" maxlength="4" style="width:120px"/>
            <button id="btnSavePin" class="small">Simpan PIN</button>
          </div>
          <div style="margin-top:10px">
            <label>Auto backup</label>
            <select id="autoBackup"><option value="off">Off</option><option value="on">On (setiap sesi)</option></select>
            <div class="muted" style="margin-top:8px">Auto backup menyimpan cadangan ke localStorage (lihat Download Backup untuk file JSON).</div>
          </div>
        </div>
      </div>

    </main>

    <footer>Build: PRO Final — local (no server). Data tersimpan di browser.</footer>
  </div>

<script>
/* -------------------------
   Simple single-file POS & Ledger app
   keys: localStorage 'cc_data' (array transactions), 'cc_products' (array), 'cc_pin', 'cc_auto_backup'
   ------------------------- */

(function(){
  // helpers
  const $ = id => document.getElementById(id);
  function fmtIDR(n){ return 'Rp ' + Number(n||0).toLocaleString('id-ID') }

  // storage helpers
  const DATA_KEY = 'cc_data', PROD_KEY='cc_products', PIN_KEY='cc_pin', AUTO_KEY='cc_auto_backup';
  let data = JSON.parse(localStorage.getItem(DATA_KEY)||'[]');
  let products = JSON.parse(localStorage.getItem(PROD_KEY)||'[]');

  // bootstrap sample products if empty
  if(!products.length){
    products = [
      {id:1,name:'Fotokopi B/W',cat:'Fotokopi',price:1500,stock:0},
      {id:2,name:'Fotokopi Warna',cat:'Fotokopi',price:4000,stock:0},
      {id:3,name:'Print Pas Foto',cat:'Fotokopi',price:20000,stock:0},
      {id:4,name:'Pulpen',cat:'ATK',price:3000,stock:0},
      {id:5,name:'Buku Tulis',cat:'ATK',price:6000,stock:0},
    ];
    localStorage.setItem(PROD_KEY, JSON.stringify(products));
  }

  // UI selectors
  const navButtons = Array.from(document.querySelectorAll('#nav button'));
  function switchPage(id){
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    const el = document.getElementById(id);
    if(el) el.style.display = 'block';
    navButtons.forEach(b=>b.classList.toggle('active', b.dataset.target===id));
  }
  navButtons.forEach(b=> b.addEventListener('click', ()=> switchPage(b.dataset.target) ));

  // render helper functions
  function saveAll(){ localStorage.setItem(DATA_KEY, JSON.stringify(data)); localStorage.setItem(PROD_KEY, JSON.stringify(products)); if(localStorage.getItem(AUTO_KEY)==='on') saveBackup(); renderAll(); }
  function nowISO(){ return new Date().toISOString() }

  // ---------- render product options & tables ----------
  function renderProductOptions(){
    const sel = $('productSelect');
    sel.innerHTML = '<option value="">-- pilih produk --</option>';
    products.forEach(p=>{
      const o = document.createElement('option');
      o.value = p.id; o.textContent = `${p.name} — Rp ${Number(p.price).toLocaleString('id-ID')}`;
      sel.appendChild(o);
    });
  }

  function renderFilterCategories(){
    const sel = $('filterCategory');
    if(!sel) return;
    sel.innerHTML = '<option value="all">Semua</option>';
    const cats = new Set(products.map(p=>p.cat||'Lainnya'));
    Array.from(cats).forEach(cat=>{
      const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; sel.appendChild(opt);
    });
  }

  function renderProductsTable(){
    const tbody = document.querySelector('#productsTable tbody');
    tbody.innerHTML = '';
    products.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.name}</td><td>${p.cat||''}</td><td>${fmtIDR(p.price)}</td><td>${p.stock||0}</td>
        <td><button class="small ghost" data-id="${p.id}">Edit</button></td>`;
      tbody.appendChild(tr);
    });
    // edit handlers (simple: remove/edit not implemented fully here)
    tbody.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const id = Number(e.currentTarget.dataset.id);
        const prod = products.find(x=>x.id===id);
        const newPrice = prompt('Ubah harga untuk '+prod.name, prod.price);
        if(newPrice!==null){ prod.price = Number(newPrice)||prod.price; saveAll(); }
      });
    });
  }

  // ---------- ledger rendering ----------
  function renderLedger(){
    const tbody = document.querySelector('#ledgerTable tbody');
    tbody.innerHTML = '';
    // filter based on ledgerRange
    const mode = $('ledgerRange') ? $('ledgerRange').value : 'daily';
    const now = new Date();
    const rows = data.slice().reverse().filter(tx=>{
      if(mode==='daily'){ const d=new Date(tx.t); return d.toDateString()===now.toDateString() }
      if(mode==='weekly'){ const d=new Date(tx.t); const diff=(now-d)/ (1000*60*60*24); return diff<=7 }
      return true;
    });
    let income=0, expense=0;
    rows.forEach(tx=>{
      const dateStr = new Date(tx.t).toLocaleString();
      const debit = tx.type==='sale'? fmtIDR(tx.total):'';
      const credit = tx.type==='expense'? fmtIDR(tx.amount):'';
      if(tx.type==='sale') income += Number(tx.total||0);
      if(tx.type==='expense') expense += Number(tx.amount||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dateStr}</td><td>${tx.desc||tx.item||''}</td><td>${tx.cat||''}</td><td>${debit}</td><td>${credit}</td>`;
      tbody.appendChild(tr);
    });
    $('totalIncome').textContent = fmtIDR(income);
    $('totalExpense').textContent = fmtIDR(expense);
    $('totalProfit').textContent = fmtIDR(income - expense);
  }

  // ---------- sales table ----------
  function renderSalesTable(){
    const tbody = document.querySelector('#salesTable tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    const sales = data.filter(tx=>tx.type==='sale').slice().reverse();
    sales.forEach(tx=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(tx.t).toLocaleString()}</td><td>${tx.item}</td><td>${tx.qty}</td><td>${fmtIDR(tx.total)}</td>
        <td><button class="small ghost" data-id="${tx.id||tx.t}">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', e=>{
        if(!confirm('Hapus transaksi?')) return;
        const id = e.currentTarget.dataset.id;
        data = data.filter(tx=> (tx.id||tx.t) !== id);
        saveAll();
      });
    });
  }

  // ---------- product management ----------
  function addProduct(name,cat,price,stock){
    const id = (products.reduce((m,p)=>Math.max(m,p.id||0),0)||0)+1;
    products.push({id,name,cat,price:Number(price||0),stock:Number(stock||0)});
    saveAll();
  }

  // ---------- add transaction ----------
  function addTransaction(tx){
    tx.t = nowISO();
    // add id for easier removal
    tx.id = Math.random().toString(36).slice(2,9);
    data.push(tx);
    // adjust stock if sale or stock-in
    if(tx.type==='sale'){
      const p = products.find(pp=>pp.id==tx.productId);
      if(p) p.stock = Math.max(0, (p.stock||0) - (tx.qty||1));
    }
    if(tx.type==='stockin'){
      const p = products.find(pp=>pp.id==tx.productId);
      if(p) p.stock = (p.stock||0) + (tx.qty||0);
    }
    saveAll();
  }

  // ---------- export / import ----------
  function exportCSV(){
    if(!data.length){ alert('Tidak ada data untuk diexport'); return; }
    const rows = [['tanggal','tipe','keterangan','kategori','debit','kredit']];
    data.forEach(tx=>{
      const t = new Date(tx.t).toLocaleString();
      if(tx.type==='sale') rows.push([t,'Penjualan', (tx.item||'') + ' x'+tx.qty, tx.cat||'', tx.total,'']);
      else if(tx.type==='expense') rows.push([t,'Pengeluaran', tx.desc||'', tx.cat||'', '', tx.amount]);
      else if(tx.type==='stockin') rows.push([t,'Stok Masuk', tx.desc||'', tx.cat||'', '', tx.amount]);
    });
    const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`copycenter_data_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  function importCSVText(text, merge=true){
    // simple CSV parse
    function parseCSV(txt){
      const rows=[]; let cur=''; let row=[]; let inQ=false;
      for(let i=0;i<txt.length;i++){
        const ch = txt[i], nxt = txt[i+1];
        if(ch==='"'){
          if(inQ && nxt==='"'){ cur+='"'; i++; continue; }
          inQ = !inQ; continue;
        }
        if(ch===',' && !inQ){ row.push(cur); cur=''; continue; }
        if((ch==='\n' || ch==='\r') && !inQ){
          if(cur!=='' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur=''; }
          continue;
        }
        cur += ch;
      }
      if(cur!=='' || row.length>0) { row.push(cur); rows.push(row); }
      return rows;
    }
    const rows = parseCSV(text).map(r=>r.map(c=>c.trim()));
    if(rows.length<2){ alert('CSV tidak valid'); return; }
    const imported=[];
    const header = rows[0].map(h=>h.toLowerCase().replace(/\s+/g,''));
    const idx = {};
    header.forEach((h,i)=>{
      if(['tanggal','date','tgl','time'].includes(h)) idx.t=i;
      if(['tipe','type'].includes(h)) idx.type=i;
      if(['keterangan','desc','description'].includes(h)) idx.desc=i;
      if(['kategori','cat'].includes(h)) idx.cat=i;
      if(['debit','masuk','income'].includes(h)) idx.debit=i;
      if(['kredit','credit','keluar','expense'].includes(h)) idx.credit=i;
    });
    for(let i=1;i<rows.length;i++){
      const r = rows[i];
      const t = r[idx.t]||new Date().toISOString();
      const typeRaw = (r[idx.type]||'').toLowerCase();
      const desc = r[idx.desc]||'';
      const debit = Number(String(r[idx.debit]||'').replace(/[^0-9\-\.]/g,''))||0;
      const credit = Number(String(r[idx.credit]||'').replace(/[^0-9\-\.]/g,''))||0;
      if(debit>0 || typeRaw.includes('penjualan') || typeRaw.includes('sale')){
        imported.push({type:'sale', item:desc, qty:1, price:debit, total:debit, t:new Date(t).toISOString()});
      } else if(credit>0 || typeRaw.includes('pengeluaran') || typeRaw.includes('expense')){
        imported.push({type:'expense', desc, cat:r[idx.cat]||'', amount:credit, t:new Date(t).toISOString()});
      }
    }
    if(!imported.length){ alert('Tidak ada transaksi valid di CSV'); return; }
    if(!merge && confirm('Ganti semua data? OK = Ganti, Cancel = Tambah/Merge')){ data = imported; }
    else data = data.concat(imported);
    saveAll(); alert('Import selesai: '+imported.length+' transaksi');
  }

  // ---------- backup JSON ----------
  function saveBackup(){
    const blob = new Blob([JSON.stringify({data,products,ts:nowISO()},null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`copycenter_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
  }

  // ---------- PIN login ----------
  function getPin(){ return localStorage.getItem(PIN_KEY) || '1234' }
  function showLoginIfNeeded(){
    if(localStorage.getItem('cc_authenticated')==='true') return;
    const pin = prompt('Masukkan PIN untuk membuka aplikasi (default 1234):','1234');
    if(pin===null) return; // canceled
    if(pin===getPin()){ localStorage.setItem('cc_authenticated','true'); alert('Login berhasil'); }
    else { alert('PIN salah'); showLoginIfNeeded(); }
  }

  // ---------- render all ----------
  function renderAll(){
    renderProductOptions();
    renderFilterCategories();
    renderProductsTable();
    renderLedger();
    renderSalesTable();
  }

  // ---------- event bindings ----------
  // Add transaction button
  $('btnAdd').addEventListener('click', ()=>{
    const type = $('txType').value;
    if(type==='sale'){
      const pid = $('productSelect').value;
      const item = $('itemName').value.trim() || (pid ? products.find(p=>p.id==pid).name : 'Penjualan');
      const qty = Number($('qty').value) || 1;
      const price = Number($('price').value) || 0;
      addTransaction({type:'sale', productId: pid?Number(pid):null, item, qty, price, total: qty*price, cat: products.find(p=>p.id==pid)?.cat||''});
      alert('Penjualan tercatat');
    } else {
      const desc = $('itemName').value.trim() || 'Pengeluaran';
      const amount = Number($('price').value) || 0;
      addTransaction({type:'expense', desc, cat: $('filterCategory').value==='all'?'':$('filterCategory').value, amount});
      alert('Pengeluaran tercatat');
    }
  });

  $('btnQuick').addEventListener('click', ()=>{
    $('txType').value='sale'; $('txType').dispatchEvent(new Event('change'));
    $('itemName').value='Fotokopi (1 lembar)'; $('qty').value=1; $('price').value=1500;
    $('btnAdd').click();
  });

  // stock in
  $('btnStockIn').addEventListener('click', ()=>{
    const pid = $('productSelect').value;
    if(!pid){ alert('Pilih produk untuk menambah stok'); return; }
    const qty = Number(prompt('Masukkan jumlah stok masuk','1')) || 0;
    addTransaction({type:'stockin', productId:Number(pid), desc:'Stok Masuk', qty, amount:0});
    alert('Stok ditambahkan');
  });

  // ledger range change
  $('ledgerRange').addEventListener('change', renderLedger);

  // product add (page)
  $('btnAddProduct').addEventListener('click', ()=>{
    const name = $('newProdName').value.trim();
    if(!name){ alert('Nama produk kosong'); return; }
    addProduct(name, $('newProdCat').value.trim()||'Lainnya', Number($('newProdPrice').value)||0, Number($('newProdStock').value)||0);
    $('newProdName').value=''; $('newProdCat').value=''; $('newProdPrice').value=''; $('newProdStock').value='';
  });

  // sales page new tx: show dashboard add form
  document.getElementById('btnNewSale')?.addEventListener('click', ()=> switchPage('page_dashboard'));

  // export / import / backup
  $('btnExportCSV').addEventListener('click', exportCSV);
  $('btnExportCSV2')?.addEventListener('click', exportCSV);
  $('btnDownloadBackup')?.addEventListener('click', saveBackup);
  $('btnDownloadBackup2')?.addEventListener('click', saveBackup);
  $('btnImport').addEventListener('click', ()=> $('fileInput').click());
  $('fileInput').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text(); importCSVText(txt, true); e.target.value='';
  });

  // print
  $('btnPrint')?.addEventListener('click', ()=> window.print());
  $('btnPrint2')?.addEventListener('click', ()=> window.print());

  // settings - PIN
  $('btnSavePin').addEventListener('click', ()=>{
    const v = $('newPin').value.trim();
    if(!v || v.length<4){ alert('PIN minimal 4 digit'); return; }
    localStorage.setItem(PIN_KEY, v); alert('PIN disimpan');
  });

  // logout
  $('btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('cc_authenticated'); alert('Logout. Silakan login lagi.'); showLoginIfNeeded(); });

  // product selection fills price & name
  $('productSelect').addEventListener('change', ()=>{
    const pid = $('productSelect').value;
    if(!pid) return;
    const p = products.find(pp=>pp.id==pid);
    if(p){ $('itemName').value = p.name; $('price').value = p.price; }
  });

  // ledger quick filter when page rendered
  $('filterCategory').addEventListener('change', ()=>{
    const cat = $('filterCategory').value;
    const sel = $('productSelect');
    sel.innerHTML = '<option value="">-- pilih produk --</option>';
    products.filter(p=> cat==='all' || p.cat===cat).forEach(p=>{
      const o = document.createElement('option'); o.value=p.id; o.textContent=`${p.name} — Rp ${Number(p.price).toLocaleString('id-ID')}`; sel.appendChild(o);
    });
  });

  // initial UI
  renderAll();

  // basic login check
  if(!localStorage.getItem('cc_authenticated')) showLoginIfNeeded();
  renderAll();

  // expose for console debugging (optional)
  window.CC = {data,products,saveAll,addTransaction,addProduct,exportCSV,saveBackup,renderAll};
})();
</script>
</body>
</html>
