<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Copycenter Antar Kita ‚Äî PRO</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f6faf8; --card:#fff; --accent:#0f766e; --muted:#6b7280;
    --btn:#0f766e; --danger:#ef4444;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:#07201f}
  .app{display:flex;min-height:100vh}
  /* sidebar */
  .sidebar{width:260px;background:linear-gradient(180deg,#055e55,#0f766e);color:#fff;padding:20px;display:flex;flex-direction:column;gap:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:8px;background:#fff;color:var(--accent);font-weight:700;display:flex;align-items:center;justify-content:center}
  .brand h3{margin:0;font-size:18px}
  .brand p{margin:0;font-size:12px;opacity:.9}
  nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .nav-btn{background:transparent;border:0;color:#e8f6f4;padding:10px;border-radius:8px;text-align:left;cursor:pointer;display:flex;gap:10px;align-items:center}
  .nav-btn.active{background:rgba(255,255,255,0.08);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}
  .side-footer{margin-top:auto}
  .pos-btn{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:#fff;cursor:pointer}

  /* main */
  .main{flex:1;padding:28px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:22px}
  .controls{display:flex;gap:8px;align-items:center}
  .controls button{background:var(--btn);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 20px rgba(12,15,30,0.06)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:16px}
  .form-row{display:flex;gap:8px}
  input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;width:100%}
  label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
  .muted{color:var(--muted);font-size:13px}
  .stat-row{display:flex;gap:8px;margin-top:12px}
  .stat{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);text-align:center}
  .stat h3{margin:0;font-size:14px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:13px;text-align:left}
  .small{font-size:13px;padding:6px 8px;border-radius:8px}
  .ghost{background:transparent;border:1px solid #e6e9ef}
  .danger{background:var(--danger);color:#fff}
  /* responsive */
  @media(max-width:980px){.grid{grid-template-columns:1fr}.sidebar{display:none}}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal .card{max-width:760px;width:100%}
</style>
</head>
<body>
<div id="app" class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">CC</div>
      <div>
        <h3 id="brandName">Copycenter Antar Kita</h3>
        <p id="brandSub">Pencatatan & Kasir</p>
      </div>
    </div>

    <nav id="nav">
      <button class="nav-btn active" data-page="dashboard">üè† Dashboard <div style="font-size:11px;color:rgba(255,255,255,0.9);margin-left:auto">Ringkasan</div></button>
      <button class="nav-btn" data-page="sales">üí∞ Penjualan<div style="font-size:11px;color:rgba(255,255,255,0.9);margin-left:auto">Tambah & riwayat</div></button>
      <button class="nav-btn" data-page="products">üì¶ Produk<div style="font-size:11px;color:rgba(255,255,255,0.9);margin-left:auto">Stok & harga</div></button>
      <button class="nav-btn" data-page="reports">üßæ Laporan<div style="font-size:11px;color:rgba(255,255,255,0.9);margin-left:auto">Export / Backup</div></button>
      <button class="nav-btn" data-page="settings">‚öôÔ∏è Pengaturan<div style="font-size:11px;color:rgba(255,255,255,0.9);margin-left:auto">PIN & Auto-backup</div></button>
    </nav>

    <div class="side-footer">
      <button class="pos-btn" id="openPOS">üìü Buka Kasir (POS)</button>
      <div style="height:10px"></div>
      <div class="muted" style="font-size:12px">Login: <b id="roleLabel">Admin</b></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header>
      <div>
        <h1 id="pageTitle">Copycenter Antar Kita ‚Äî Pencatatan Lengkap</h1>
        <div class="muted" id="pageSubtitle">Penjualan (fotokopi/print/pas foto/atk/minuman), pengeluaran, stok, laporan & backup.</div>
      </div>

      <div class="controls">
        <input id="searchBox" placeholder="Cari: item / keterangan" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <select id="filterRange" class="small">
          <option value="today">Hari ini</option>
          <option value="week">7 hari</option>
          <option value="month">Bulan ini</option>
        </select>
        <button id="btnExportCSV" class="small">Export CSV</button>
        <button id="btnExportStock" class="small ghost">Export Stok</button>
        <button id="btnImportCSV" class="small ghost">Import CSV</button>
        <button id="btnBackup" class="small">Download Backup</button>
        <button id="btnPrintPDF" class="small ghost">Cetak PDF</button>
        <button id="btnLogout" class="small ghost">Logout</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: input transaksi -->
      <section>
        <div class="card">
          <h3>Tambah Transaksi</h3>
          <div style="display:flex;gap:10px;margin-top:8px">
            <div style="flex:1">
              <label>Jenis</label>
              <select id="txType">
                <option value="sale">Penjualan (fotokopi / print / produk)</option>
                <option value="expense">Pengeluaran</option>
              </select>
            </div>
            <div style="width:180px">
              <label>Filter Kategori</label>
              <select id="filterCategory"><option value="all">Semua</option></select>
            </div>
          </div>

          <div id="saleFields" style="margin-top:12px">
            <label>Produk / Layanan</label>
            <select id="productSelect"></select>

            <label style="margin-top:8px">Nama Item / Layanan</label>
            <input id="itemName" placeholder="Contoh: Fotokopi A4 (1 lembar)" />

            <div class="form-row" style="margin-top:8px">
              <div style="flex:1"><label>Jumlah</label><input id="qty" type="number" min="1" value="1" /></div>
              <div style="width:160px"><label>Harga per Unit (Rp)</label><input id="price" type="number" min="0" value="1500" /></div>
            </div>
          </div>

          <div id="expenseFields" style="display:none;margin-top:12px">
            <label>Deskripsi Pengeluaran</label>
            <input id="expDesc" placeholder="Contoh: Pembelian kertas" />
            <label style="margin-top:8px">Kategori</label>
            <select id="expCat"><option>Operasional</option><option>Perlengkapan</option><option>Gaji</option><option>Lainnya</option></select>
            <label style="margin-top:8px">Jumlah (Rp)</label>
            <input id="expAmount" type="number" min="0" value="50000" />
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="btnAddTx">Tambah</button>
            <button id="btnQuick" class="ghost">Tambah Cepat (Rp 1.500 x 1)</button>
            <button id="btnStockIn" class="ghost">Stok Masuk</button>
          </div>

          <div class="stat-row">
            <div class="stat"><h3>Total Pemasukan</h3><p id="sumIncome">Rp 0</p></div>
            <div class="stat"><h3>Total Pengeluaran</h3><p id="sumExpense">Rp 0</p></div>
            <div class="stat"><h3>Keuntungan</h3><p id="sumProfit">Rp 0</p></div>
          </div>

          <!-- filter & table -->
          <div style="margin-top:12px">
            <h4>Filter & Cari</h4>
            <div class="form-row">
              <input id="searchDesc" placeholder="Cari keterangan..." />
              <select id="rangeSelect"><option value="today">Hari ini</option><option value="week">7 hari</option><option value="month">Bulan ini</option></select>
              <button id="btnApplyFilter" class="small ghost">Filter</button>
            </div>
          </div>
        </div>

        <!-- produk & stok (singkat) -->
        <div class="card" style="margin-top:16px">
          <h3>Daftar Produk & Stok</h3>
          <table id="productTable"><thead><tr><th>Produk</th><th>Kategori</th><th>Harga</th><th>Stok</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- RIGHT: buku kas / ledger -->
      <aside>
        <div class="card">
          <h3>Buku Kas / Ledger</h3>
          <label>Tampilkan</label>
          <select id="ledgerRange"><option value="daily">Harian</option><option value="weekly">Mingguan</option><option value="all">Semua</option></select>
          <div style="margin-top:8px;max-height:420px;overflow:auto">
            <table id="ledgerTable"><thead><tr><th>Tgl</th><th>Keterangan</th><th>Kategori</th><th>Debit</th><th>Kredit</th><th></th></tr></thead><tbody></tbody></table>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="btnFilterToday" class="small">Filter Hari Ini</button>
            <button id="btnShowAll" class="small ghost">Tampilkan Semua</button>
          </div>
          <div class="muted" style="margin-top:8px">Data transaksi & stok tersimpan di browser (localStorage). Backup via Export CSV / Download Backup.</div>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- MODAL POS -->
<div id="posModal" style="display:none" class="modal">
  <div class="card">
    <h3>POS - Kasir Cepat</h3>
    <div style="display:flex;gap:8px">
      <select id="posProduct" style="flex:1"></select>
      <input id="posQty" type="number" value="1" style="width:90px" />
      <button id="posAdd" class="small">Tambahkan</button>
    </div>
    <div style="margin-top:12px">
      <table id="posCart"><thead><tr><th>Item</th><th>Qty</th><th>Harga</th><th>Total</th><th></th></tr></thead><tbody></tbody></table>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div><b>Total:</b> <span id="posTotal">Rp 0</span></div>
      <div style="display:flex;gap:8px">
        <button id="posPrint" class="small">Cetak Struk</button>
        <button id="posCheckout" class="small">Bayar</button>
        <button id="posClose" class="small ghost">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- hidden file input for import -->
<input type="file" id="fileInput" accept=".csv" style="display:none">

<script>
/* ===========================
   Simple PRO app logic
   - stores data in localStorage keys:
     products_key, tx_key, users_key, settings_key
   - default PIN = 1234 (Admin)
   =========================== */

(() => {
  // storage keys
  const PRODUCTS = 'cc_products_v1'
  const TX = 'cc_tx_v1'
  const SETTINGS = 'cc_settings_v1'
  const USERS = 'cc_users_v1'

  // init defaults
  function getStore(k, def) { try { return JSON.parse(localStorage.getItem(k)) || def } catch(e){ return def } }
  function setStore(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

  // defaults: sample products
  if(!localStorage.getItem(PRODUCTS)){
    const sample = [
      {id: 'p1', name:'Fotokopi B/W', cat:'Fotokopi', price:1500, stock:200},
      {id: 'p2', name:'Fotokopi Warna', cat:'Fotokopi', price:4000, stock:50},
      {id: 'p3', name:'Print Pas Foto', cat:'Fotokopi', price:20000, stock:20},
      {id: 'p4', name:'Pulpen', cat:'ATK', price:3000, stock:100},
      {id: 'p5', name:'Aqua 600ml', cat:'Minuman', price:5000, stock:60},
      {id: 'p6', name:'Rokok Surya Kecil', cat:'Rokok', price:27000, stock:20},
    ]
    setStore(PRODUCTS, sample)
  }
  if(!localStorage.getItem(TX)) setStore(TX, [])
  if(!localStorage.getItem(SETTINGS)){
    setStore(SETTINGS, {pin:'1234', pin_enabled:true, theme:'light', autoBackup:false})
  }
  if(!localStorage.getItem(USERS)){
    setStore(USERS, [{id:'u_admin',name:'Admin',role:'admin'}])
  }

  // helpers
  const $ = id => document.getElementById(id)
  function money(n){ return 'Rp ' + Number(n||0).toLocaleString('id-ID') }
  function nowISO(){ return new Date().toISOString() }

  // app state
  let products = getStore(PRODUCTS, [])
  let tx = getStore(TX, [])
  let settings = getStore(SETTINGS, {})
  let userRole = 'admin' // default after login - simplified

  // UI elements
  const navBtns = document.querySelectorAll('.nav-btn')
  const pageTitle = $('pageTitle'), pageSubtitle = $('pageSubtitle')
  const productSelect = $('productSelect'), filterCategory = $('filterCategory'), productTableBody = document.querySelector('#productTable tbody')
  const ledgerBody = document.querySelector('#ledgerTable tbody'), ledgerRange = $('ledgerRange')
  const sumIncomeEl = $('sumIncome'), sumExpenseEl = $('sumExpense'), sumProfitEl = $('sumProfit')
  const txType = $('txType'), saleFields = $('saleFields'), expenseFields = $('expenseFields')
  const btnAddTx = $('btnAddTx'), btnQuick = $('btnQuick'), btnStockIn = $('btnStockIn'), btnExportCSV = $('btnExportCSV'), fileInput = $('fileInput')
  const btnImportCSV = $('btnImportCSV'), btnBackup = $('btnBackup'), btnPrintPDF = $('btnPrintPDF'), openPOS = $('openPOS')
  const posModal = $('posModal'), posProduct = $('posProduct'), posQty = $('posQty'), posAdd = $('posAdd'), posCart = document.querySelector('#posCart tbody')
  const posTotal = $('posTotal'), posCheckout = $('posCheckout'), posPrint = $('posPrint'), posClose = $('posClose')
  const searchBox = $('searchBox'), filterRange = $('filterRange'), btnLogout = $('btnLogout'), btnExportStock = $('btnExportStock')
  const btnFilterToday = $('btnFilterToday'), btnShowAll = $('btnShowAll'), btnApplyFilter = $('btnApplyFilter')
  const rangeSelect = $('rangeSelect'), searchDesc = $('searchDesc')

  // initial render
  function renderProducts(){
    products = getStore(PRODUCTS, [])
    // categories
    const cats = ['all', ...new Set(products.map(p=>p.cat))]
    filterCategory.innerHTML = cats.map(c=>`<option value="${c}">${c==='all'?'Semua':c}</option>`).join('')
    // product select for quick add
    productSelect.innerHTML = products.map(p=>`<option value="${p.id}">${p.name} ‚Äî Rp ${p.price.toLocaleString('id-ID')}</option>`).join('')
    posProduct.innerHTML = productSelect.innerHTML
    // table
    productTableBody.innerHTML = products.map(p=>`<tr>
      <td>${p.name}</td><td>${p.cat}</td><td>${money(p.price)}</td><td>${p.stock}</td>
      <td><button class="small ghost" data-id="${p.id}" onclick="editProduct('${p.id}')">Edit</button></td>
    </tr>`).join('')
  }

  // expose editProduct to global for inline onclick to work
  window.editProduct = function(id){
    const p = products.find(x=>x.id===id)
    if(!p) return alert('Produk tidak ditemukan')
    const n = prompt('Nama produk', p.name)
    if(n===null) return
    const cat = prompt('Kategori', p.cat) || p.cat
    const pr = Number(prompt('Harga (Rp)', p.price) || p.price)
    const st = Number(prompt('Stok', p.stock) || p.stock)
    p.name = n; p.cat = cat; p.price = pr; p.stock = st
    setStore(PRODUCTS, products); renderProducts(); renderLedger(); renderSummary()
  }

  function renderLedger(filter='all'){
    tx = getStore(TX, [])
    const rows = tx.slice().reverse().filter(t=>{
      if(filter==='daily'){
        const d = new Date(t.t), now = new Date()
        return d.getFullYear()==now.getFullYear() && d.getMonth()==now.getMonth() && d.getDate()==now.getDate()
      }
      if(filter==='weekly'){
        const d = new Date(t.t), now = new Date()
        const diff = (now - d) / (1000*60*60*24)
        return diff <= 7
      }
      return true
    })
    ledgerBody.innerHTML = rows.map((r,i)=>{
      return `<tr>
        <td>${new Date(r.t).toLocaleString()}</td>
        <td>${r.type==='sale'? r.item : r.desc}</td>
        <td>${r.type==='expense'? (r.cat||'') : (r.cat||'')}</td>
        <td>${r.type==='sale'? money(r.total) : ''}</td>
        <td>${r.type==='expense'? money(r.amount) : ''}</td>
        <td><button class="small ghost" data-i="${tx.length-1-i}" onclick="removeTx(${tx.length-1-i})">Hapus</button></td>
      </tr>`
    }).join('')
  }

  window.removeTx = function(i){
    if(!confirm('Hapus transaksi?')) return
    tx.splice(i,1); setStore(TX, tx); renderLedger(ledgerRange.value); renderSummary(); renderDashboard()
  }

  function renderSummary(){
    tx = getStore(TX, [])
    const income = tx.filter(t=>t.type==='sale').reduce((s,n)=>s + Number(n.total||0),0)
    const expense = tx.filter(t=>t.type==='expense').reduce((s,n)=>s + Number(n.amount||0),0)
    sumIncomeEl.textContent = money(income)
    sumExpenseEl.textContent = money(expense)
    sumProfitEl.textContent = money(income - expense)
  }

  // dashboard small render
  function renderDashboard(){
    // small chart of last 7 days
    // we will render chart only if Chart exists
    try{
      const ctxId = 'salesChart'
      // create canvas container if not present
      let card = document.querySelector('.dashboard-chart')
      if(!card){
        card = document.createElement('div'); card.className='card dashboard-chart'; card.style.marginTop='16px'
        card.innerHTML = '<h3>Grafik Penjualan (7 hari)</h3><canvas id="salesChart" height="120"></canvas>'
        document.querySelector('.main').appendChild(card)
      }
      const ctx = document.getElementById('salesChart').getContext('2d')
      // aggregate last 7 days
      const last7 = []
      for(let i=6;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate() - i)
        last7.push(d.toLocaleDateString())
      }
      const data = last7.map(day=>{
        const total = tx.filter(t=>{
          if(t.type!=='sale') return false
          const d = new Date(t.t)
          return d.toLocaleDateString()=== new Date(day).toLocaleDateString()
        }).reduce((s,n)=>s + Number(n.total||0),0)
        return total
      })
      if(window.salesChart) window.salesChart.destroy()
      window.salesChart = new Chart(ctx, {
        type:'bar',
        data:{labels:last7,datasets:[{label:'Pemasukan',data:data,backgroundColor:'#0f766e'}]},
        options:{plugins:{legend:{display:false}},scales:{y:{ticks:{callback: (v)=> 'Rp '+v}}}
      })
    }catch(e){ console.warn('chart err',e) }
  }

  // transactions add
  function addSale(item, qty, price, options={}){
    const total = qty * price
    const obj = {type:'sale', item, qty, price, total, t: nowISO(), ...options}
    tx.push(obj); setStore(TX, tx)
    // reduce stock if product id provided
    if(options.productId){
      const p = products.find(x=>x.id===options.productId); if(p) { p.stock = Math.max(0, p.stock - qty); setStore(PRODUCTS, products); renderProducts() }
    }
    renderLedger(ledgerRange.value); renderSummary(); renderDashboard()
  }
  function addExpense(desc, cat, amount){
    const obj = {type:'expense', desc, cat, amount, t: nowISO()}
    tx.push(obj); setStore(TX, tx); renderLedger(ledgerRange.value); renderSummary()
  }

  // UI events
  txType.addEventListener('change', e=>{
    if(e.target.value==='sale'){ saleFields.style.display='block'; expenseFields.style.display='none' }
    else { saleFields.style.display='none'; expenseFields.style.display='block' }
  })

  btnAddTx.addEventListener('click', ()=>{
    if(txType.value==='sale'){
      const pid = productSelect.value
      const p = products.find(x=>x.id===pid)
      const itemName = $('itemName').value.trim() || (p? p.name : 'Penjualan')
      const qty = Number($('qty').value) || 1
      const price = Number($('price').value) || (p? p.price : 0)
      addSale(itemName, qty, price, {productId: pid, cat: p? p.cat : ''})
      alert('Transaksi penjualan tersimpan.')
      // clear
      $('itemName').value=''; $('qty').value=1; $('price').value=1500
    } else {
      const desc = $('expDesc').value.trim() || 'Pengeluaran'
      const cat = $('expCat').value
      const amount = Number($('expAmount').value) || 0
      addExpense(desc,cat,amount)
      alert('Pengeluaran tersimpan.')
      $('expDesc').value=''; $('expAmount').value=50000
    }
  })
  btnQuick.addEventListener('click', ()=>{
    txType.value='sale'; txType.dispatchEvent(new Event('change'))
    const pid = productSelect.value
    const p = products.find(x=>x.id===pid)
    const price = p? p.price : 1500
    addSale(p? p.name : 'Fotokopi', 1, price, {productId: pid, cat: p? p.cat:''})
    alert('Tambah cepat berhasil.')
  })

  btnStockIn.addEventListener('click', ()=>{
    const pid = productSelect.value
    const qty = Number(prompt('Jumlah masuk (tambah stok)', '10') || 0)
    if(qty<=0) return
    const p = products.find(x=>x.id===pid); if(!p) return
    p.stock = (p.stock||0) + qty; setStore(PRODUCTS, products); renderProducts()
    // record as expense? optional
    tx.push({type:'expense', desc:`Stok masuk ${p.name} x${qty}`, cat:'Stok', amount:0, t:nowISO()})
    setStore(TX,tx); renderLedger(ledgerRange.value)
    alert('Stok ditambahkan.')
  })

  // ledger range buttons
  btnFilterToday.addEventListener('click', ()=>renderLedger('daily'))
  btnShowAll.addEventListener('click', ()=>renderLedger('all'))
  ledgerRange.addEventListener('change', ()=>renderLedger(ledgerRange.value==='daily'?'daily': ledgerRange.value==='weekly'?'weekly':'all'))

  // export CSV (transactions)
  btnExportCSV.addEventListener('click', ()=>{
    tx = getStore(TX, [])
    if(!tx.length) return alert('Tidak ada data untuk diexport.')
    const rows = [['tanggal','tipe','keterangan','kategori','debit','kredit']]
    tx.forEach(t=>{
      if(t.type==='sale') rows.push([new Date(t.t).toLocaleString(),'Penjualan', t.item, t.cat || '', t.total, ''])
      else rows.push([new Date(t.t).toLocaleString(),'Pengeluaran', t.desc, t.cat || '', '', t.amount])
    })
    const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')
    const blob = new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a')
    a.href=url; a.download=`copycenter_data_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url)
  })

  btnExportStock.addEventListener('click', ()=>{
    products = getStore(PRODUCTS, [])
    if(!products.length) return alert('Tidak ada stok.')
    const rows = [['id','nama','kategori','harga','stok']]
    products.forEach(p=> rows.push([p.id,p.name,p.cat,p.price,p.stock]))
    const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n')
    const blob = new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a')
    a.href=url; a.download=`copycenter_stock_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url)
  })

  // import CSV basic
  btnImportCSV.addEventListener('click', ()=> fileInput.click())
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return
    const txt = await f.text()
    const rows = parseCSV(txt).map(r=>r.map(c=>c.trim()))
    if(rows.length<2) return alert('CSV tidak valid.')
    // simple detection: if header contains 'produk' treat as stock import else tx import
    const header = rows[0].map(h=>h.toLowerCase().replace(/\s/g,''))
    const isStock = header.includes('nama') && header.includes('stok')
    if(isStock){
      // map and update/add products
      rows.slice(1).forEach(r=>{
        const id = r[0] || ('p'+Math.random().toString(36).slice(2,8))
        const name = r[1]||'Unnamed'; const cat=r[2]||'Lainnya'; const price = Number(r[3]||0); const stock = Number(r[4]||0)
        const ex = products.find(x=>x.id===id || x.name===name)
        if(ex){ ex.name=name; ex.cat=cat; ex.price=price; ex.stock=stock }
        else products.push({id,name,cat,price,stock})
      })
      setStore(PRODUCTS, products); renderProducts(); alert('Import stok selesai.')
    } else {
      // import transactions (best-effort)
      const imported=[]
      for(let i=1;i<rows.length;i++){
        const r = rows[i]; if(r.length<3) continue
        const tipe = (r[1]||'').toLowerCase()
        if(tipe.includes('penjualan')|| tipe.includes('sale')){
          const item = r[2]||'Penjualan'; const debit = Number((r[4]||'').replace(/[^0-9\-\.]/g,'')) || 0
          imported.push({type:'sale', item, qty:1, price:debit, total:debit, t:new Date(r[0]||Date.now()).toISOString()})
        } else {
          const desc = r[2]||'Pengeluaran'; const kredit = Number((r[5]||'').replace(/[^0-9\-\.]/g,'')) || 0
          imported.push({type:'expense', desc, cat:'', amount:kredit, t:new Date(r[0]||Date.now()).toISOString()})
        }
      }
      if(imported.length) { tx = tx.concat(imported); setStore(TX, tx); renderLedger('all'); renderSummary(); alert('Import transaksi selesai: '+imported.length) }
      else alert('Tidak ada transaksi valid ditemukan.')
    }
  })

  // CSV parse helper (handles quotes)
  function parseCSV(text){
    const rows=[]; let cur=''; let row=[]; let inQ=false
    for(let i=0;i<text.length;i++){
      const ch=text[i], nxt=text[i+1]
      if(ch==='"'){ if(inQ && nxt==='"'){ cur+='"'; i++; continue } inQ=!inQ; continue }
      if(ch===',' && !inQ){ row.push(cur); cur=''; continue }
      if((ch==='\n' || ch==='\r') && !inQ){
        if(cur!=='' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur='' }
        continue
      }
      cur+=ch
    }
    if(cur!=='' || row.length>0){ row.push(cur); rows.push(row) }
    return rows
  }

  // backup download (JSON)
  btnBackup.addEventListener('click', ()=>{
    const payload = {products: getStore(PRODUCTS,[]), tx: getStore(TX,[]), settings: getStore(SETTINGS, {})}
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'})
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `copycenter_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url)
  })

  // print PDF - we implement using window.print with separate minimal window
  btnPrintPDF.addEventListener('click', ()=>{
    const rows = tx || []
    let html = `<html><head><title>Laporan - ${new Date().toLocaleDateString()}</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:6px}</style></head><body><h2>Copycenter Antar Kita - Laporan</h2><table><thead><tr><th>Tanggal</th><th>Keterangan</th><th>Debit</th><th>Kredit</th></tr></thead><tbody>`
    rows.forEach(r=>{
      html += `<tr><td>${new Date(r.t).toLocaleString()}</td><td>${r.type==='sale'? r.item : r.desc}</td><td>${r.type==='sale'? r.total : ''}</td><td>${r.type==='expense'? r.amount : ''}</td></tr>`
    })
    html += `</tbody></table><script>window.onload=()=>setTimeout(()=>{window.print();},300)</script></body></html>`
    const w = window.open('','_blank'); w.document.write(html); w.document.close()
  })

  // POS modal
  let cart = []
  openPOS.addEventListener('click', ()=>{ posModal.style.display='flex'; renderPOS() })
  posClose.addEventListener('click', ()=>{ posModal.style.display='none'; cart=[]; renderPOS() })
  posAdd.addEventListener('click', ()=>{
    const pid = posProduct.value; const qty = Number(posQty.value) || 1
    const p = products.find(x=>x.id===pid); if(!p) return
    cart.push({id:pid,name:p.name,qty,price:p.price}); renderPOS()
  })
  function renderPOS(){
    posProduct.innerHTML = products.map(p=>`<option value="${p.id}">${p.name} ‚Äî ${money(p.price)}</option>`).join('')
    posCart.innerHTML = cart.map((c,i)=>`<tr><td>${c.name}</td><td>${c.qty}</td><td>${money(c.price)}</td><td>${money(c.qty*c.price)}</td><td><button class="small ghost" onclick="removeCart(${i})">Hapus</button></td></tr>`).join('')
    const total = cart.reduce((s,c)=>s + c.qty*c.price,0); posTotal.textContent = money(total)
  }
  window.removeCart = function(i){ cart.splice(i,1); renderPOS() }

  posCheckout.addEventListener('click', ()=>{
    if(!cart.length) return alert('Keranjang kosong')
    cart.forEach(c=> addSale(c.name,c.qty,c.price,{productId:c.id,cat:(products.find(p=>p.id===c.id)||{}).cat}))
    // print receipt
    printReceipt(cart)
    cart=[]
    renderPOS(); alert('Transaksi sukses & struk dicetak (jika browser mengizinkan).')
  })
  posPrint.addEventListener('click', ()=>{ if(!cart.length) return alert('Keranjang kosong'); printReceipt(cart) })

  function printReceipt(items){
    const total = items.reduce((s,c)=>s + c.qty*c.price,0)
    let html = `<html><head><title>Struk</title><style>body{font-family:Arial;padding:10px}h2{text-align:center}</style></head><body><h2>Copycenter Antar Kita</h2><p>${new Date().toLocaleString()}</p><table style="width:100%"><tbody>`
    items.forEach(it=> html += `<tr><td>${it.name} x${it.qty}</td><td style="text-align:right">${money(it.qty*it.price)}</td></tr>`)
    html += `</tbody></table><hr><h3 style="text-align:right">${money(total)}</h3><p style="text-align:center">Terima kasih</p><script>window.onload=()=>setTimeout(()=>window.print(),300)</script></body></html>`
    const w = window.open('','_blank'); w.document.write(html); w.document.close()
  }

  // search & filter
  btnApplyFilter.addEventListener('click', ()=>{
    const q = searchDesc.value.toLowerCase(); const mode = rangeSelect.value
    const rows = getStore(TX, []).filter(t=>{
      if(q && !( (t.item||'').toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q) )) return false
      if(mode==='today'){ const d = new Date(t.t), n=new Date(); return d.getFullYear()==n.getFullYear() && d.getMonth()==n.getMonth() && d.getDate()==n.getDate() }
      if(mode==='week'){ const d = new Date(t.t), diff=(new Date()-d)/(1000*60*60*24); return diff<=7 }
      return true
    })
    ledgerBody.innerHTML = rows.map(r=>`<tr><td>${new Date(r.t).toLocaleString()}</td><td>${r.type==='sale'?r.item:r.desc}</td><td>${r.cat||''}</td><td>${r.type==='sale'?money(r.total):''}</td><td>${r.type==='expense'?money(r.amount):''}</td><td></td></tr>`).join('')
  })

  // logout
  btnLogout.addEventListener('click', ()=>{
    if(confirm('Logout?')) { location.reload() }
  })

  // navigation handlers
  navBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      navBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active')
      const page = b.dataset.page
      showPage(page)
    })
  })

  function showPage(name){
    // hide all main content and manage focus - simple approach: adjust pageTitle/subtitle and ensure ledger & lists render
    if(name==='dashboard'){ pageTitle.textContent='Dashboard'; pageSubtitle.textContent='Memantau penjualan, stok, dan laporan'; }
    if(name==='sales'){ pageTitle.textContent='Penjualan'; pageSubtitle.textContent='Tambah penjualan & riwayat transaksi' }
    if(name==='products'){ pageTitle.textContent='Produk & Stok'; pageSubtitle.textContent='Kelola produk dan harga' }
    if(name==='reports'){ pageTitle.textContent='Laporan & Backup'; pageSubtitle.textContent='Export CSV, backup, dan cetak laporan' }
    if(name==='settings'){ pageTitle.textContent='Pengaturan'; pageSubtitle.textContent='PIN & Auto-backup' }
    renderLedger('all'); renderProducts(); renderSummary(); renderDashboard()
  }

  // initial render
  renderProducts(); renderLedger('all'); renderSummary(); renderDashboard()

  // quick diagnostics console guard
  console.log('Copycenter PRO ready ‚Äî theme:', settings.theme)

  // expose some debug helpers
  window.CC = { addSale, addExpense, products, tx }
})()
</script>
</body>
</html>
